<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>

    <style>
        .event-log-row {
            padding: 1rem 0;
            font-size: 0.8rem;
            word-break: break-word;
            transition: 0.2s ease;
            align-items: center;
        }

        .event-row-time {
            text-align: center;
        }

        .event-log-row:hover {
            box-shadow: inset 5px 0 0 0 gray;
            background-color: lightgray;
        }

        .modal-dialog {
            max-width: 95vw;
        }

        .event-log-row a {
            text-decoration: none;
            color: unset;
        }

        .event-log-row button {
            background-color: transparent;
            border: 1px transparent solid;
        }

        .event-log-row button:hover {
            border: 1px black solid;
        }

    </style>
</head>
<body>
<template id="template-event-log-row">
    <div class="row event-log-row">
        <div class="col-1 event-row-time" style="padding: 0 8px">
        </div>
        <div class="col-1 event-row-level">
        </div>
        <div class="col-2 event-row-entity">
        </div>
        <div class="col-3 event-row-activity">
        </div>
        <div class="col-5" style="max-height: 10rem; overflow: auto;" data-expand>
            <pre class="event-row-detail" style="margin: 0; word-break: keep-all;overflow: visible"></pre>
        </div>
    </div>
</template>

<div class="container-fluid">
    <div class="row filter-container"></div>
    <div class="row">
        <div class="col-1">时间</div>
        <div class="col-1">分级</div>
        <div class="col-2">实体</div>
        <div class="col-3">行为</div>
        <div class="col-4">信息</div>
    </div>
    <hr/>
    <hr id="insert-event-log-before"/>
    <div class="row d-none event-eof-mark mb-3" style="text-align:center; color: gray; display: block">
        &lt;&lt;&lt;EOF&gt;&gt;&gt;
    </div>
</div>
<div class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="word-break: break-all">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script src="js/safe.js"></script>
<script>
    function addStartFilter(element) {
        submitee.filterbar.add({
            key: "start",
            displayKey: "起始时间",
            value: parseInt($(element).attr("data-timestamp")),
            datePicker: true
        });
        reloadWithFilters();
    }

    function addLevelFilter(element) {
        submitee.filterbar.add({
            key: "level",
            displayKey: "分级",
            value: element.querySelector("span").textContent
        });
        reloadWithFilters();
    }

    function addEntityFilter(element) {
        submitee.filterbar.add({
            key: "entity",
            displayKey: "实体",
            value: element.textContent
        });
        reloadWithFilters();
    }

    function addActivityFilter(element) {
        submitee.filterbar.add({
            key: "activity",
            displayKey: "行为",
            value: element.textContent
        });
        reloadWithFilters();
    }

    function reloadWithFilters() {
        window.location.href = fullQueryWithFilters();
    }

    function fullQueryWithFilters() {
        let q = "?method=event-log";
        let startFilter = submitee.filterbar.get("start");
        if (startFilter) q += "&st=" + startFilter;
        let levelFilter = submitee.filterbar.get("level");
        if (levelFilter) q += "&lv=" + encodeURIComponent(levelFilter);
        let entityFilter = submitee.filterbar.get("entity");
        if (entityFilter) q += "&et=" + encodeURIComponent(entityFilter);
        let activityFilter = submitee.filterbar.get("activity");
        if (activityFilter) q += "&ac=" + encodeURIComponent(activityFilter);
        return q;
    }

    function fetchEventLogs(callback, start) {
        $.ajax({
            url: "../events",
            method: "GET",
            data: {
                level: submitee.filterbar.get("level"),
                entity: submitee.filterbar.get("entity"),
                activity: submitee.filterbar.get("activity"),
                start: start,
                limit: 20
            },
            success: callback,
            error: toast_ajax_error
        })
    }

    /**
     *
     * @param {Date} date
     */
    function truncateDate(date) {
        date.setHours(0);
        date.setMinutes(0)
        date.setSeconds(0);
        date.setMilliseconds(0);
    }

    function formatDate(time) {
        time = parseInt(time);
        let target = new Date(time);
        let now = new Date();
        truncateDate(target);
        truncateDate(now);
        let offset = (target.getTime() - now.getTime()) / (3600 * 1000 * 24);

        let literal = new Date(time).toLocaleTimeString();
        if (offset !== 0) {
            literal += ` (${offset > 0 ? '+' + offset : offset})`;
        }
        return literal;
    }

    function appendEventRow(time, collapse) {
        let relative = $("#insert-event-log-before")[0];
        let template = $("#template-event-log-row")[0];
        template.content.querySelector(".event-row-time").innerHTML =
            `<button data-timestamp="${time}" onclick="addStartFilter(this)">${formatDate(time)}</button>`;
        template.content.querySelector(".event-row-time").setAttribute("title", new Date(parseInt(time)).toLocaleString());
        let levelHtml;
        switch (collapse["levelText"]) {
            case "INFO":
                levelHtml = `<span class='text-info'>INFO</span>`;
                break;
            case "WARN":
                levelHtml = `<span class="text-warning">WARN</span>`;
                break;
            case "ERROR":
                levelHtml = `<span class="text-danger">ERROR</span>`;
                break;
            default:
                levelHtml = `<span class="text-secondary">OTHER</span>`;
                break;
        }
        template.content.querySelector(".event-row-level").innerHTML = `<button onclick="addLevelFilter(this)">${levelHtml}</button>`;
        template.content.querySelector(".event-row-entity").innerHTML = `<button onclick="addEntityFilter(this)">${collapse["entity"]}</button>`;
        template.content.querySelector(".event-row-activity").innerHTML = `<button onclick="addActivityFilter(this)">${collapse["activity"]}</button>`;
        template.content.querySelector(".event-row-detail").textContent = collapse["detail"];
        relative.parentNode.insertBefore(document.importNode(template.content, true), relative);
    }

    async function renderEventLogs(errors) {
        submitee.eventPageEarlyTime = null;
        let collapseMap = {};
        for (let collapse of errors) {
            let id = makeid(6);
            collapse['temp_id'] = id;
            collapseMap[id] = collapse;
        }
        let sort = {};
        for (let collapse of errors) {
            let id = collapse["temp_id"];
            collapse["occurs"].forEach((t) => sort[t] = id);
        }
        let early;
        Object.keys(sort).sort(function (o1, o2) {
            return o2 - o1;
        }).forEach(t => {
            let id = sort[t];
            appendEventRow(t, collapseMap[id]);
            early = t;
        })
        submitee.eventPageEarlyTime = early;

        if (Object.keys(sort).length) {
            $(".event-eof-mark").removeClass("d-none");
        }

        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight
            && submitee.eventPageEarlyTime) {
            fetchEventLogs(renderEventLogs, submitee.eventPageEarlyTime);
            submitee.eventPageEarlyTime = null;
        }
    }

    function addFilterbarElements() {
        let start = getQueryValue("st");
        if ((start = parseInt(start))) {
            submitee.filterbar.add({
                key: "start",
                displayKey: "起始时间",
                value: start,
                removeCallback: reloadWithFilters,
                setValueCallback: reloadWithFilters,
                datePicker: true
            })
        }
        let level = getQueryValue("lv");
        if (level) {
            submitee.filterbar.add({
                key: "level",
                displayKey: "分级",
                value: level,
                removeCallback: reloadWithFilters,
                setValueCallback: reloadWithFilters
            })
        }
        let entity = getQueryValue("et");
        if (entity) {
            submitee.filterbar.add({
                key: "entity",
                displayKey: "实体",
                value: entity,
                removeCallback: reloadWithFilters,
                setValueCallback: reloadWithFilters
            });
        }
        let activity = getQueryValue("ac");
        if (activity) {
            submitee.filterbar.add({
                key: "activity",
                displayKey: "行为",
                value: activity,
                removeCallback: reloadWithFilters,
                setValueCallback: reloadWithFilters
            });
        }
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js",
        "https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "js/model.js",
        "js/field-controllers.js",
        "js/toast.js",
        "js/session.js",
        "js/filterbar.js"
    ]).then(() => {
        submitee.filterbar = createFilterBar(".filter-container");
        addFilterbarElements();

        let start = submitee.filterbar.get("start");
        if (start) start = parseInt(start);
        if (!start) start = -1;
        fetchEventLogs(renderEventLogs, start);

        $(".container-fluid").on("click", "[data-expand]", function (evt) {
            $(".modal .modal-title").text("detail");
            $(".modal .modal-body").html(`<pre>${evt.target.textContent}</pre>`);
            $(".modal").modal();
        })

        window.onscroll = function (ev) {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
                if (!submitee.eventPageEarlyTime) return;
                fetchEventLogs(renderEventLogs, submitee.eventPageEarlyTime);
                submitee.eventPageEarlyTime = null;
            }
        };
    });
</script>
</body>
</html>