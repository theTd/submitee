<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title></title>

    <style>
        .s-template-row {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .s-template-row > .col {
            align-self: center;
        }

        .s-template-id, .s-template-status {
            font-size: 0.8rem;
        }

        .s-template-row span {
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
            display: inline-block;
        }

        span.template-status-editing {
            border: 1px #17a2b8 solid;
            color: #17a2b8;
        }

        span.template-status-published {
            border: 1px #28a745 solid;
            background-color: #28a745;
            color: white !important;
        }

        span.template-status-archived {
            border: 1px #dc3545 solid;
            color: #dc3545;
        }

        .template-filters > * {
            vertical-align: middle;
        }

        .template-filters > label {
            margin: 0;
        }

        .filter-button {
            background-color: transparent;
            border: 1px solid transparent;
        }

        .filter-button:hover {
            border: 1px black solid;
        }

        .s-template-id, .s-template-actions {
            max-width: 100px;
        }

        .s-template-status {
            max-width: 80px;
        }

        .s-template-actions {
            max-width: 150px;
        }

        .s-template-name {
            max-width: 200px;
        }

        .header {
            /*font-weight: bold;*/
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

<template id="template-s-template-row">
    <div class="row s-template-row">
        <div class="col s-template-id"></div>
        <div class="col s-template-status"></div>
        <div class="col s-template-name"></div>
        <div class="col s-template-comment"></div>
        <div class="col s-template-actions">
            <div class="template-link-container position-relative d-none" style="right: 2.5rem"></div>
            <button class="btn btn-sm btn-secondary button-edit-template d-none" onclick="editTemplate(this)">
                编辑
            </button>
            <button class="btn btn-sm btn-outline-danger button-archive-template d-none"
                    onclick="archiveTemplate(this)">
                归档
            </button>
            <button class="btn btn-sm btn-info button-view-template d-none" onclick="editTemplate(this)">
                查看
            </button>
            <button class="btn btn-sm btn-warning button-revision-template d-none" onclick="revisionTemplate(this)">
                修订
            </button>
            <button class="btn btn-sm btn-danger button-delete-template d-none" onclick="deleteTemplate(this)">
                删除
            </button>
        </div>
    </div>
</template>
<template id="template-list-page-item">
    <li class="page-item">
        <button class="page-link"></button>
    </li>
</template>

<div class="container-fluid">
    <div class="row filter-container"></div>
    <div class="row">
        <div class="col s-template-id header">编号</div>
        <div class="col s-template-status header">状态</div>
        <div class="col s-template-name header">标题</div>
        <div class="col s-template-comment header">注释</div>
        <div class="col s-template-actions header"></div>
    </div>
    <hr/>
    <div class="row empty-mark d-none col-12 justify-content-center" style="color: gray; font-style: italic">(空)</div>
    <hr id="insert-template-before"/>
    <nav class="row col">
        <ul class="pagination" id="template-list-pagination">
        </ul>
    </nav>
    <hr/>
    <div class="row justify-content-end mb-3">
        <div class="col template-filters">
            <label for="checkbox-show-archived">显示归档</label>
            <input type="checkbox" id="checkbox-show-archived" data-toggle="toggle" data-size="sm" data-on="开"
                   data-off="关"/>
        </div>
        <div class="col s-template-actions">
            <a class="btn btn-outline-success" href="#" onclick="createTemplate()">创建<br/>模板</a>
        </div>

    </div>
</div>

<script src="js/safe.js"></script>
<script>
    function archiveTemplate(element) {
        let templateId = findTemplateIdByElement(element);

        $.ajax({
            url: `../template-control/${templateId}/archive`,
            method: "GET",
            success: function (response) {
                create_toast("提示", "已完成");
                setInterval(() => {
                    window.location.reload();
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr);
            }
        });
    }

    function deleteTemplate(element) {
        let templateId = findTemplateIdByElement(element);

        $.ajax({
            url: `../template-control/${templateId}/delete`,
            method: "GET",
            success: function (response) {
                create_toast("提示", "已完成");
                setInterval(() => {
                    window.location.reload();
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr);
            }
        });
    }

    function revisionTemplate(element) {
        let id = findTemplateIdByElement(element);
        $.ajax({
            url: "../create/template/" + id,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({}),
            success: function (data) {
                create_toast("提示", "<p>正在重定向...</p>");
                setTimeout(() => {
                    window.location.href = "?method=edit-template&target=" + data;
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr)
            }
        });
    }

    function createTemplate() {
        $.ajax({
            url: "../create/template",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({}),
            success: function (data) {
                create_toast("提示", "<p>创建成功</p><p>正在重定向...</p>");
                setTimeout(() => {
                    window.location.href = "?method=edit-template&target=" + data;
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr)
            }
        });
    }

    function findTemplateIdByElement(element) {
        return findParentAttributeByElement(element, "data-submitee-template-id");
    }

    function editTemplate(element) {
        let templateId = findTemplateIdByElement(element);
        window.location.href = "management.html?method=edit-template&target=" + templateId;
    }

    /**
     *
     * @param {STemplate} template
     */
    function createTemplateElement(template) {
        let t = document.querySelector("#template-s-template-row");
        let node = document.importNode(t.content, true);
        $(node).find(".s-template-row").attr("data-submitee-template-id", template.uniqueId);
        $(node).find(".s-template-id").html(`<button type="button" class="filter-button">${template.templateId}:</button>${template.version}`)
            .find("button").on("click", () => addTemplateIdFilter(template.templateId));

        $(node).find(".s-template-status").html(`<button type="button" class="filter-button">${template.status}</button>`)
            .find("button").on("click", () => addStateFilter(template.literalState));

        $(node).find(".s-template-name").text(template.name);
        $(node).find(".s-template-comment").text(template.comment);

        if (template.published) {
            $(node).find(".template-link-container").removeClass("d-none").append(
                createOutFlowIconTooltip("link", "2rem", "gray", "复制链接", "top", () => {
                    navigator.clipboard.writeText(template.submissionPageLink).then(() => {
                        create_toast("提示", "已复制到剪切板", 2000, "copy-submission-link");
                    });
                })
            )
            $(node).find(".button-revision-template").removeClass("d-none");
            $(node).find(".button-view-template").removeClass("d-none");
            $(node).find(".button-edit-template").addClass("d-none");
            $(node).find(".button-archive-template").addClass("d-none");
            $(node).find(".button-delete-template").addClass("d-none");
        } else {
            $(node).find(".template-link-container").addClass("d-none");
            $(node).find(".button-view-template").addClass("d-none");

            if (template.archived) {
                $(node).find(".button-revision-template").removeClass("d-none");
                $(node).find(".button-edit-template").addClass("d-none");
                $(node).find(".button-archive-template").addClass("d-none");
                $(node).find(".button-delete-template").removeClass("d-none");
            } else {
                $(node).find(".button-revision-template").addClass("d-none");
                $(node).find(".button-edit-template").removeClass("d-none");
                $(node).find(".button-archive-template").removeClass("d-none");
                $(node).find(".button-delete-template").addClass("d-none");
            }
        }

        return node;
    }

    function buildTemplateList(templateList) {
        let relative = $("#insert-template-before")[0];
        templateList.forEach(function (value) {
            relative.parentNode.insertBefore(createTemplateElement(value), relative);
        })
    }

    function buildPagination(currentPage, maxPages) {
        let paginationContainer = $("#template-list-pagination")[0];
        let prevPage = currentPage - 1;
        if (prevPage < 1) prevPage = null;
        let nextPage = currentPage + 1;
        if (nextPage > maxPages) nextPage = null;

        let node;
        node = createPageItem("上一页", prevPage);
        if (!prevPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);

        for (let i = 1; i <= maxPages; i++) {
            paginationContainer.appendChild(createPageItem(i, i, i === currentPage));
        }

        node = createPageItem("下一页", nextPage);
        if (!nextPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);
    }

    function createPageItem(text, page, active) {
        let t = $("#template-list-page-item")[0];
        // t.content.querySelector(".page-link").href = "javascript:switchToPage(" + page + ")";

        t.content.querySelector(".page-link").textContent = text;
        if (active) {
            $(t.content.querySelector(".page-item")).addClass("active");
        } else {
            $(t.content.querySelector(".page-item")).removeClass("active");
        }
        let node = document.importNode(t.content, true);
        if (page) $(node).find(".page-link").on("click", () => reloadWithFilters(page))
        return node;
    }

    function reloadWithFilters(page) {
        window.location.href = fullQueryWithFilters(page);
    }

    function fullQueryWithFilters(page) {
        let q = "?method=template-list";
        page = page || parseInt(getQueryValue("page"));
        q += "&page=" + page;
        // noinspection EqualityComparisonWithCoercionJS
        let showArchived = $("#checkbox-show-archived").prop("checked");
        q += "&ac=" + showArchived;

        let tid = submitee.filterbar.get("tid");
        if (tid) q += "&tid=" + tid;
        let state = submitee.filterbar.get("state");
        if (state) q += "&st=" + state;
        return q;
    }

    function addStateFilter(state) {
        submitee.filterbar.add({
            key: "state",
            displayKey: "状态",
            value: state,
            displayValue: getLocaleState(state)
        })
        reloadWithFilters();
    }

    function addTemplateIdFilter(templateId) {
        submitee.filterbar.add({
            key: "tid",
            displayKey: "模板ID",
            value: templateId
        })
        reloadWithFilters();
    }

    function getLocaleState(state) {
        let displayValue = state;
        if (state === 'archived') {
            displayValue = "归档";
        } else if (state === 'published') {
            displayValue = "发布";
        } else if (state === 'editing') {
            displayValue = "编辑";
        }
        return displayValue;
    }

    function addFilterbarElements() {
        let tid = getQueryValue("tid");
        if (tid) {
            submitee.filterbar.add({
                key: "tid",
                displayKey: "模板ID",
                value: tid,
                removeCallback: reloadWithFilters,
                setValueCallback: reloadWithFilters
            });
        }
        let state = getQueryValue("st");
        if (state) {
            submitee.filterbar.add({
                key: "state",
                displayKey: "状态",
                value: state,
                displayValue: getLocaleState(state),
                removeCallback: reloadWithFilters,
                setValueCallback: reloadWithFilters,
                selectionFeeder: {
                    "editing": "编辑",
                    "published": "发布",
                    "archived": "归档"
                }
            });
        }
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js",
        "https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "js/model.js",
        "js/field-controllers.js",
        "js/toast.js",
        "js/session.js",
        "js/filterbar.js"
    ]).then(() => {
        submitee.filterbar = createFilterBar(".filter-container");
        addFilterbarElements();

        const pageSize = 10;
        let page = parseInt(getQueryValue("page")) || 1;

        // noinspection EqualityComparisonWithCoercionJS
        let showArchived = getQueryValue("ac") == 'true';

        $("#checkbox-show-archived").prop("checked", showArchived).bootstrapToggle()
            .on("change", () => setTimeout(() => window.location.href = fullQueryWithFilters(), 200));

        let filters = {};
        if (!showArchived) {
            filters["$or"] = [
                {"archived": {"$exists": false}},
                {"archived": false}
            ];
        }
        let stateFilter = submitee.filterbar.get("state");
        if (stateFilter) {
            if (stateFilter === 'archived') {
                filters["archived"] = true;
            } else if (stateFilter === 'published') {
                filters["published"] = true;
            } else if (stateFilter === "editing") {
                filters["$and"] = [
                    {"published": false},
                    {
                        "$or": [
                            {"archived": {"$exists": false}},
                            {"archived": false}
                        ]
                    }
                ];
            }
        }
        let tidFilter = submitee.filterbar.get("tid");
        if (tidFilter) {
            filters["template-id"] = tidFilter;
        }

        fetchTemplateSize(filters, false).then(size => {
            if (size === 0) {
                $(".empty-mark").removeClass("d-none");
                return;
            }
            let maxPages = Math.ceil(size / pageSize);
            if (page > maxPages) page = maxPages;
            buildPagination(page, maxPages);
            fetchTemplateInfo(filters, false, (page - 1) * pageSize, pageSize)
                .then(buildTemplateList, toast_ajax_error)
        }, toast_ajax_error);
    });

</script>
</body>
</html>
