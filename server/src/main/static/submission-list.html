<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title></title>

    <style>
        .submission-row {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<template id="template-submission-page-item">
    <li class="page-item"><a class="page-link" href="#">3</a></li>
</template>
<template id="template-submission-row">
    <div class="row submission-row">
        <div class="col-1 submission-template-id">模板</div>
        <div class="col-2 submission-user">提交者</div>
        <div class="col-2 submission-time">时间</div>
        <div class="col-6">
            <pre class="submission-debug">摘要</pre>
        </div>
        <div class="col-1">
            <!--            <div class="submission-detail"></div>-->
            <button class="btn btn-outline-info btn-sm" onclick="showDetail(this)">详情</button>
        </div>
    </div>
</template>
<div class="container-fluid">
    <div class="row">
        <div class="col-1">模板</div>
        <div class="col-2">提交者</div>
        <div class="col-2">时间</div>
        <div class="col-6">摘要</div>
        <div class="col-1"></div>
    </div>
    <hr/>
    <hr id="insert-submission-before"/>
    <nav class="row col">
        <ul class="pagination" id="submission-list-pagination">
        </ul>
    </nav>
</div>
<script>
    function showDetail(element) {
        submitee.currentSubmissionTarget =
            findParentAttributeByElement(element, "data-submitee-submission-uuid");
        let pagePromise = submitee.getPage("submission-detail.html");

        let over = false;

        if (submitee.shownPopover) {
            submitee.shownPopover.popover('dispose');
        }

        submitee.shownPopover = $(element);
        submitee.shownPopover.popover('dispose');
        $(element).on("shown.bs.popover", async function (evt) {
            let popoverTarget = getPopoverTarget(evt.target);
            document.addEventListener("submission-detail-loaded", () => {
                $(element).popover('update');
            });
            let page = await pagePromise;
            $(popoverTarget).css("max-width", "40rem").css("padding", "0").css("margin", "0").html(page)
                .on("mouseenter mouseleave", (evt) => {
                    if (evt.type === "mouseenter") {
                        setTimeout(() => over = true, 500);
                    } else if (over) {
                        $(element).popover("hide");
                    }
                });
        }).popover({
            placement: 'left',
            html: true,
            content: "<span class='spinner-border'></span>"
        }).popover('show');
    }

    function getPopoverTarget(element) {
        let id = $(element).attr("aria-describedby");
        return $("#" + id)[0];
    }

    /**
     *
     * @param {Submission} submission
     * @returns {*}
     */
    function createSubmissionElement(submission) {
        let t = document.querySelector("#template-submission-row");

        t.content.querySelector(".submission-row").setAttribute("data-submitee-submission-uuid", submission.attributeMap.get("unique-id"));

        t.content.querySelector(".submission-template-id").innerHTML = "<p class='spinner-border spinner-border-sm'></p>";
        t.content.querySelector(".submission-debug").textContent = submission.debug;
        t.content.querySelector(".submission-time").textContent = submission.submitTime;
        t.content.querySelector(".submission-user").innerHTML = submission.submitUser;
        setTimeout(() => {
            updateTemplateInfo(submission);
        })
        return document.importNode(t.content, true);
    }

    async function updateTemplateInfo(submission) {
        let t = await fetchSingleTemplateInfo(submission.attributeMap.get("template-uuid"));
        let container = $(`.submission-row[data-submitee-submission-uuid=${submission.attributeMap.get("unique-id")}]`);
        container.find(".submission-template-id").text(t.templateId + ":" + t.version);
    }

    function buildSubmissionList(submissionList) {
        let relative = $("#insert-submission-before")[0];
        submissionList.forEach(function (value, key) {
            relative.parentNode.insertBefore(createSubmissionElement(value), relative);
        })
    }

    function buildPagination(currentPage, maxPages) {
        let paginationContainer = $("#submission-list-pagination")[0];
        let prevPage = currentPage - 1;
        if (prevPage < 1) prevPage = null;
        let nextPage = currentPage + 1;
        if (nextPage > maxPages) nextPage = null;

        let node;
        node = createPageItem("上一页", prevPage ? "?method=submission-list&page=" + prevPage : "");
        if (!prevPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);

        for (let i = 1; i <= maxPages; i++) {
            paginationContainer.appendChild(createPageItem(i, "?method=submission-list&page=" + i, i === currentPage));
        }

        node = createPageItem("下一页", nextPage ? "?method=submission-list&page=" + nextPage : "");
        if (!nextPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);
    }

    function createPageItem(text, href, active) {
        let t = $("#template-submission-page-item")[0];
        t.content.querySelector(".page-link").href = href;
        t.content.querySelector(".page-link").textContent = text;
        if (active) {
            $(t.content.querySelector(".page-item")).addClass("active");
        } else {
            $(t.content.querySelector(".page-item")).removeClass("active");
        }
        return document.importNode(t.content, true);
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js",
        "https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "js/model.js",
        "js/field-controllers.js",
        "js/toast.js",
        "js/session.js",
    ]).then(() => {
        $(document).on('click', (evt) => {
            if (submitee.shownPopover) {
                let popover = submitee.shownPopover[0];
                let popoverTarget = getPopoverTarget(submitee.shownPopover[0]);
                if (popover && popover.contains(evt.target)) return;
                if (popoverTarget && popoverTarget.contains(evt.target)) return;
                submitee.shownPopover.popover('hide');
            }
        });

        const pageSize = 10;
        let page = parseInt(getQueryValue("page")) || 1;

        fetchSubmissionInfo({}).then(array => {
            if (array.length === 0) {
                $(".empty-mark").removeClass("d-none");
                return;
            }
            let maxPages = Math.ceil(array.length / pageSize);
            if (page > maxPages) page = maxPages;
            buildPagination(page, maxPages);

            let shown = Array();
            for (let i = pageSize * (page - 1); i < pageSize * page && i < array.length; i++) {
                shown.push(array[i]);
            }

            buildSubmissionList(shown);
        }, xhr => {
            toast_ajax_error(xhr);
        });
    });
</script>
</body>
</html>
