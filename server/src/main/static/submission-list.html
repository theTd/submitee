<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title></title>

    <style>
        .submission-row {
            padding: 1rem 0;
            font-size: 0.8rem;
            word-break: break-word;
            transition: 0.2s ease;
            align-items: center;
        }

        .submission-row:hover {
            box-shadow: inset 5px 0 0 0 gray;
            background-color: lightgray;
        }

        .filter-button {
            margin: 0;
            padding: 0;
            border: 1px transparent solid;
            background-color: transparent;
        }

        .filter-button:hover {
            border: 1px black solid;
        }

        .template-uuid-section {
            cursor: pointer;
            border: 1px transparent solid;
        }

        .template-uuid-section:hover {
            border: 1px black solid;
        }

        .submission-debug {
            margin: 0;
        }
    </style>
</head>
<body>
<template id="template-submission-page-item">
    <li class="page-item"><a class="page-link" href="#">3</a></li>
</template>
<template id="template-submission-row">
    <div class="row submission-row">
        <div class="col-1 submission-template-id">模板</div>
        <div class="col-2 submission-user">提交者</div>
        <div class="col-2 submission-time">时间</div>
        <div class="col-6">
            <pre class="submission-debug">摘要</pre>
        </div>
        <div class="col-1">
            <!--            <div class="submission-detail"></div>-->
            <button class="btn btn-outline-info btn-sm" onclick="showDetail(this)">详情</button>
        </div>
    </div>
</template>
<div class="container-fluid">
    <div class="row filter-container"></div>
    <div class="row header">
        <div class="col-1">
            <button class="filter-button" onclick="addTidFilter()">模板</button>
        </div>
        <div class="col-2">提交者</div>
        <div class="col-2">
            <button class="filter-button" onclick="addStartFilter()">时间</button>
        </div>
        <div class="col-6">摘要</div>
        <div class="col-1"></div>
    </div>
    <hr/>
    <hr id="insert-submission-before"/>
    <nav class="row col">
        <ul class="pagination" id="submission-list-pagination">
        </ul>
    </nav>
</div>
<div class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="word-break: break-all">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showDetail(element) {
        submitee.currentSubmissionTarget =
            findParentAttributeByElement(element, "data-submitee-submission-uuid");

        $(".modal .modal-title").text("提交详情");
        $(".modal .modal-body").html("<span class='spinner-border'></span>");
        $(".modal").modal();
        submitee.getPage("submission-detail.html").then(page => {
            $(".modal .modal-body").html(page);
        });

    }

    /**
     *
     * @param {Submission} submission
     * @returns {*}
     */
    function createSubmissionElement(submission) {
        let node = document.importNode(document.querySelector("#template-submission-row").content, true)

        $(node).find(".submission-row").attr("data-submitee-submission-uuid", submission.attributeMap.get("unique-id"));

        $(node).find(".submission-template-id").html("<p class='spinner-border spinner-border-sm'></p>");
        $(node).find(".submission-debug").text(submission.debug.substr(0, submission.debug.length - 1));
        $(node).find(".submission-time").html(`
<button class="filter-button" onclick="addStartFilter(this)" data-timestamp="${submission.submitTime}">
${submitee.relativeTimeLocale(submission.submitTime)}
</button>
`
        ).attr("title",
            new Date(submission.submitTime).toLocaleString());
        $(node).find(".submission-user").html(submission.submitUser);
        return node;
    }

    async function buildSubmissionList(submissionList) {
        let relative = $("#insert-submission-before")[0];

        // template uuid=>promise map
        let templatePromises = {};
        // template uuid=>promise resolve,reject function map
        let completeMap = {};
        let setPromise = Array();

        for (let submission of submissionList) {
            let templateUUID = submission.templateUUID;
            if (!templatePromises[templateUUID]) {
                setPromise.push(new Promise(setResolve => {
                    templatePromises[templateUUID] = new Promise((resolve, reject) => {
                        completeMap[templateUUID] = {
                            resolve: resolve,
                            reject: reject
                        }
                        setResolve();
                    });
                }))
            }
        }

        // wait for complete map all set
        await Promise.all(setPromise);

        // make batch-get request
        fetchListedTemplateInfo(Object.keys(completeMap)).then(map => {
            // resolve found
            for (let id of Object.keys(map)) {
                completeMap[id].resolve((map[id]));
            }
            // reject not found
            Object.keys(templatePromises).filter(t => !map[t]).forEach(miss => {
                completeMap[miss].reject();
            })
        }, error => {
            for (let map of Object.values(completeMap)) {
                map.reject(error);
            }
        });

        for (let submission of submissionList) {
            let p = templatePromises[submission.templateUUID];
            relative.parentNode.insertBefore(createSubmissionElement(submission), relative);
            let inserted = $(`.submission-row[data-submitee-submission-uuid=${submission.uniqueId}]`);
            p.then(t => {
                $(inserted).find(".submission-template-id").text(t.templateId + ":" + t.version);
                $(inserted).find(".submission-template-id").html(`
<div class="template-uuid-section filter-button" data-tid="${t.uniqueId}">
<button class="filter-button" onclick="addTidFilter(this)" data-tid="${t.templateId}">${t.templateId}</button>
:${t.version}</div>
`
                ).find(".template-uuid-section")[0].addEventListener("click", (evt) => addTidFilter(evt.target), false);

            }, error => {
                $(inserted).find(".submission-template-id").html("").append(
                    createIconTooltip("error", "1rem", "red", `<span>${getMessageFromAjaxError(error)}</span>`, "top"));
            });
        }
    }

    function buildPagination(currentPage, maxPages) {
        let paginationContainer = $("#submission-list-pagination")[0];
        let prevPage = currentPage - 1;
        if (prevPage < 1) prevPage = null;
        let nextPage = currentPage + 1;
        if (nextPage > maxPages) nextPage = null;

        let node;
        node = createPageItem("上一页", prevPage ? "?method=submission-list&page=" + prevPage : "");
        if (!prevPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);

        for (let i = 1; i <= maxPages; i++) {
            paginationContainer.appendChild(createPageItem(i, "?method=submission-list&page=" + i, i === currentPage));
        }

        node = createPageItem("下一页", nextPage ? "?method=submission-list&page=" + nextPage : "");
        if (!nextPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);
    }

    function createPageItem(text, href, active) {
        let t = $("#template-submission-page-item")[0];
        t.content.querySelector(".page-link").href = href;
        t.content.querySelector(".page-link").textContent = text;
        if (active) {
            $(t.content.querySelector(".page-item")).addClass("active");
        } else {
            $(t.content.querySelector(".page-item")).removeClass("active");
        }
        return document.importNode(t.content, true);
    }

    function fullQueryWithFilters(page) {
        let q = "?method=submission-list";
        page = page || parseInt(getQueryValue("page"));
        q += "&page=" + page;

        let tid = submitee.filterbar.get("tid");
        if (tid) q += "&tid=" + encodeURIComponent(tid);
        let start = submitee.filterbar.get("start");
        if (start) q += "&start=" + start;
        return q;
    }

    function addStartFilter(element) {
        submitee.filterbar.setValue("start", element ? $(element).attr("data-timestamp") : null);
    }

    function addTidFilter(element) {
        submitee.filterbar.setValue("tid", element ? $(element).attr("data-tid") : null);
    }

    function reloadWithFilters() {
        window.location.href = fullQueryWithFilters();
    }

    function initFilterbar(templates, templateVersionMap) {
        submitee.filterbar.init({
            key: "tid",
            displayKey: "模板",
            value: getQueryValue("tid"),
            setValueCallback: reloadWithFilters,
            removeCallback: reloadWithFilters,
            controller: new TemplateFilterbarController(templates, templateVersionMap)
        })
        submitee.filterbar.init({
            key: "start",
            displayKey: "起始时间",
            value: parseInt(getQueryValue("start")),
            setValueCallback: reloadWithFilters,
            removeCallback: reloadWithFilters,
            datePicker: true
        })
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js",
        "https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "js/model.js",
        "js/field-controllers.js",
        "js/toast.js",
        "js/session.js",
        "js/filterbar.js",
        "js/template-filterbar-controller.js"
    ]).then(async () => {
        submitee.filterbar = createFilterBar(".filter-container");
        let templates = await fetchTemplateInfo({}, false, 0, null, true);
        let templateVersionMap = {};
        for (let t of templates) {
            let arr = templateVersionMap[t.templateId];
            if (!arr) {
                arr = Array();
                templateVersionMap[t.templateId] = arr;
            }
            arr.push(t);
        }
        for (let arr of Object.values(templateVersionMap)) {
            arr.sort((a, b) => {
                return b.version - a.version;
            });
        }

        initFilterbar(templates, templateVersionMap);

        const pageSize = 10;
        let page = parseInt(getQueryValue("page")) || 1;
        let filters = {};
        let tidFilter = submitee.filterbar.get("tid")
        if (tidFilter) {
            if (submitee.uuidPattern.test(tidFilter)) {
                filters["template-uuid"] = tidFilter;
            } else {
                let or = Array();
                filters["$or"] = or;
                for (let t of templateVersionMap[tidFilter]) {
                    or.push({"template-uuid": t.uniqueId});
                }
            }
        }
        let startFilter = submitee.filterbar.get("start");
        if (startFilter) {
            filters["submit-time"] = {"$gte": parseInt(startFilter)};
        }

        fetchSubmissionSize(filters).then(size => {
            if (size === 0) {
                $(".empty-mark").removeClass("d-none");
                return;
            }

            let maxPages = Math.ceil(size / pageSize);
            if (page > maxPages) page = maxPages;
            buildPagination(page, maxPages);
            fetchSubmissionInfo(filters, (page - 1) * pageSize, pageSize)
                .then(buildSubmissionList, toast_ajax_error);
        });
    });
</script>
</body>
</html>
