<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
</head>
<body>
<template id="template-field-container">
    <div class="row field-container">
        <div class="col-3 container-field-name"></div>
        <div class="col-9 container-field-body">
            <div class="container-field-report"></div>
            <div class="container-field-desc"></div>
        </div>
    </div>
</template>
<div class="submission-detail">
    <span class="submission-detail-spinner spinner-border"></span>
    <p class="template-name" style="margin: 0 0 1rem 0; padding-left: 1rem;"></p>
    <div class="container-fluid md-1" style="min-width: 400px">
        <div class="insert-fields-before"></div>
        <button class="btn btn-sm btn-outline-info" id="btn-add-tag">添加标签</button>
        <button class="btn btn-sm btn-outline-info">导出</button>
        <button class="btn btn-sm btn-outline-info" id="btn-cascade">级联菜单测试</button>
        <button class="btn btn-sm btn-outline-info" id="btn-editable-cascade">可编辑级联菜单测试</button>
    </div>
</div>

<script src="js/safe.js"></script>
<script>
    function createFieldLine(controller, field, reportHtml) {
        let node = document.importNode($("#template-field-container")[0].content, true);
        let fieldTypeName = submitee.fieldControllers[field.type].displayName;

        $(node).find(".container-field-name").text(`[${fieldTypeName}] ${field.name}`);
        if (field.comment) {
            $(node).find(".container-field-desc").html(field.comment);
        } else {
            $(node).find(".container-field-desc").addClass("d-none");
        }

        $(node).find(".container-field-report").html(reportHtml);
        $(node).find(".field-container").attr("data-submitee-field-name", field.name);
        $(node).find(".field-container").attr("id", controller.getContainerId(field));
        return node;
    }

    async function buildFields(submission) {
        let relative = $(".insert-fields-before")[0];

        for (let field of submitee.currentTemplate.fields) {
            let typeController = submitee.fieldControllers[field.type];

            let value = submission.attributeMap.get("body." + field.name);

            let report = await typeController.generateReportHtml(field, value);
            relative.parentNode.insertBefore(createFieldLine(typeController, field, report), relative);
        }
        document.dispatchEvent(new CustomEvent("submission-detail-loaded"));
    }

    /**
     *
     * @param {Submission} submission
     */
    function loadSubmission(submission) {
        setCurrentTemplate(submission.attributeMap.get("template-uuid"), () => {
            let relativeTimeLocale = submitee.relativeTimeLocale(submission.submitTime);
            let timeLocale = new Date(submission.submitTime).toLocaleString();
            $(".submission-detail-spinner").addClass("d-none");
            $(".template-name").html(`${submitee.currentTemplate.name}<span class="ml-1" style="font-size: 1rem; color: #e3e3e3">
 由 ${submission.submitUser} 于 <span title="${timeLocale}">${relativeTimeLocale}</span> 提交</span>`);
            let title = submission.submitUser + "于" + new Date(submission.submitTimeRaw).toLocaleTimeString() + "上传至" +
                submitee.currentTemplate.templateId + ":" + submitee.currentTemplate.version;
            setTitle(title);
            buildFields(submission);
        })
    }

    submitee_safe.loadAllStylesheet([
        "https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css",
        "https://fonts.googleapis.com/icon?family=Material+Icons",
        "css/global.css"
    ]).then(() => {
        submitee_safe.appendStyleSheet(`
.submission-detail .template-name {
    width: 100%;
    margin-left: 1rem;
    background-color: #8d8d8d;
    font-size: 2rem;
    color: white;
}

.submission-detail .field-container {
    margin: 1rem 0;
    padding-top: 0.2rem;
    padding-bottom: 0.2rem;
    transition: 0.2s cubic-bezier(0.22, 0.61, 0.36, 1);
    border-radius: 10px;
}

.submission-detail .field-container:hover {
    box-shadow: 0 0 0 3px rgb(255, 191, 110) !important;
}
        `, "submission-detail.html");
    });
    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js",
        "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "https://cdn.jsdelivr.net/npm/uppy@1.27.0/dist/uppy.min.js",
        "https://cdn.jsdelivr.net/npm/@uppy/locales@1.18.0/dist/zh_CN.min.js",
        "js/model.js",
        "js/session.js",
        "js/field-controllers.js",
        "js/ui.js"
    ]).then(() => {
        let target = submitee.currentSubmissionTarget || getQueryValue("target");
        if (!target || !submitee.uuidPattern.test(target)) {
            $(".submission-detail-spinner").addClass("d-none");
            create_toast("重要提示", "请检查链接合法性");
            return;
        }

        fetchSubmissionInfo({'unique-id': target}).then(array => {
            if (!array || array.length === 0) {
                create_toast("重要提示", "未找到目标提交");
                return;
            }
            loadSubmission(array[0]);

            let tagList = [
                {name: "紫色", color: "#af00af"},
                {name: "红色", color: "#ff4242"},
                {name: "黄色", color: "#FFC21A"}
            ];

            $("#btn-add-tag").on("click", () => {
                let list = new class extends EditableCascadedList {
                    onCreate(selection) {
                        tagList.push(selection);
                    }

                    findIndex(sel) {
                        for (let i = 0; i < tagList.length; i++) {
                            if (tagList[i].name === sel.name) {
                                return i;
                            }
                        }
                    }

                    onDelete(selection) {
                        tagList.splice(this.findIndex(selection), 1);
                    }

                    onFinalSelect(selection) {
                        console.log("selected " + selection.name);
                    }

                    onEdit(selection, newSelection) {
                        let d = tagList[this.findIndex(selection)];
                        Object.assign(d, newSelection);
                    }

                    onMoveUp(selection) {
                        let idx = this.findIndex(selection);
                        let newIdx = idx - 1;
                        let d = tagList.splice(idx, 1);
                        tagList.splice(newIdx, 0, d[0]);
                    }

                    onMoveDown(selection) {
                        let idx = this.findIndex(selection);
                        let newIdx = idx + 1;
                        let d = tagList.splice(idx, 1);
                        tagList.splice(newIdx, 0, d[0]);
                    }
                }
                tagList.forEach(d => list.addSelection(d));
                list.show("#btn-add-tag");
            });

            $("#btn-cascade").on("click", async () => {
                let modelPromise = new Promise(resolve => {
                    $.ajax({
                        url: "assets/region.json",
                        success: function (response) {
                            let obj;
                            if (typeof response === 'string') {
                                obj = JSON.parse(response);
                            } else {
                                obj = response;
                            }
                            let model = {};
                            for (let id of Object.keys(obj).sort()) {
                                let tid = id.substr(4);
                                let sid = id.substr(2, 2);
                                let fid = id.substr(0, 2);
                                let display = obj[id];
                                if (tid === '00') {
                                    if (sid === '00') {
                                        // first class
                                        model[id] = {id: id, display: display};
                                    } else {
                                        // second class
                                        let o = model[fid + "0000"];
                                        if (!o) continue;

                                        let child = o["child"];
                                        if (!child) {
                                            child = {};
                                            o["child"] = child;
                                        }
                                        child[id] = {id: id, display: display};
                                    }
                                } else {
                                    // third class
                                    let lvl = model[fid + "0000"];
                                    if (lvl["child"]) {
                                        let s = lvl["child"][fid + sid + "00"];
                                        if (s) lvl = s;
                                    }

                                    let child = lvl["child"];
                                    if (!child) {
                                        child = {};
                                        lvl["child"] = child;
                                    }
                                    child[id] = {id: id, display: display};
                                }
                            }
                            resolve(model);
                        }
                    })
                })

                let model = await modelPromise;

                let fnInitCascadedList = function (struct) {
                    let list = new RegionCascadedList();
                    for (let k of Object.keys(struct)) {
                        let obj = struct[k];
                        obj["id"] = k;
                        list.addSelection(obj);
                    }
                    return list;
                }

                class RegionCascadedList extends CascadedList {
                    onFinalSelect(selection) {
                        console.log(`selected ${selection.display} (${selection.id})`);
                    }

                    haveCascadeList(selection) {
                        return selection["child"];
                    }

                    getCascadeList(selection) {
                        return fnInitCascadedList(selection["child"]);
                    }

                    getSelectionKey(selection) {
                        return selection["display"];
                    }

                    enableSearch() {
                        return true;
                    }
                }

                let rootList = fnInitCascadedList(model);
                rootList.show("#btn-cascade");
            });

            let rootData = [{name: "initial element"}];

            $("#btn-editable-cascade").on("click", () => {

                let createListFn = function (dataList) {
                    let lst = new list(dataList);
                    for (let d of dataList) {
                        lst.addSelection(d);
                    }
                    return lst;
                }

                let list = class extends EditableCascadedList {
                    constructor(dataList) {
                        super();
                        this.dataList = dataList;
                    }

                    findDataListIndex(selection) {
                        let name = selection["name"];
                        for (let i = 0; i < this.dataList.length; i++) {
                            if (this.dataList[i].name === name) {
                                return i;
                            }
                        }
                    }

                    getCascadeList(selection) {
                        let child = selection["child"];
                        if (child) {
                            return createListFn(child);
                        } else {
                            selection["child"] = Array();
                            return createListFn(selection["child"]);
                        }
                    }

                    haveCascadeList(selection) {
                        return selection["child"];
                    }

                    onMoveUp(selection) {
                        let idx = this.findDataListIndex(selection);
                        let newIdx = idx - 1;
                        let d = this.dataList.splice(idx, 1);
                        this.dataList.splice(newIdx, 0, d[0]);
                    }

                    onMoveDown(selection) {
                        let idx = this.findDataListIndex(selection);
                        let newIdx = idx + 1;
                        let d = this.dataList.splice(idx, 1);
                        this.dataList.splice(newIdx, 0, d[0]);
                    }

                    onEdit(selection, newSelection) {
                        let idx = this.findDataListIndex(selection);
                        if (idx === -1) {
                            console.warn("idx of datalist not found of selection " + this.getSelectionKey(selection));
                            return;
                        }
                        let d = this.dataList[idx];
                        d.name = newSelection.name;
                        d.color = newSelection.color;
                    }

                    onCreate(selection) {
                        this.dataList.push(JSON.parse(JSON.stringify(selection)));
                    }

                    onDelete(selection) {
                        this.dataList.splice(this.findDataListIndex(selection), 1);
                    }

                    allowCreateCascadeList() {
                        return true;
                    }

                    onFinalSelect(selection) {
                        console.log(selection.name + " is selected");
                    }
                }

                let lst = createListFn(rootData);
                lst.show("#btn-editable-cascade", "bottom");
            });
        })
    })
</script>
</body>
</html>
