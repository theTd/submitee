<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

    <link rel="stylesheet" href="css/global.css">
    <style>
        .template-name {
            width: 100%;
            margin-left: 1rem;
            background-color: #8d8d8d;
            font-size: 2rem;
            color: white;
        }

        .field-container {
            margin: 1rem 0;
            padding-top: 0.2rem;
            padding-bottom: 0.2rem;
            transition: 0.2s cubic-bezier(0.22, 0.61, 0.36, 1);
            border-radius: 10px;
        }

        .field-container:hover {
            box-shadow: 0 0 0 3px rgb(255, 191, 110) !important;
        }

        .tag-list-edit-button {
            margin: 0;
            padding: 0;
            border: 0;
            font-size: 0.8rem;
            background-color: transparent;
            transition: 0.2s cubic-bezier(0.22, 0.61, 0.36, 1);
        }

        .tag-list-edit-button:hover {
            color: #28a745;
        }

        .tag-list-edit-button:active {
            box-shadow: none;
        }
    </style>
</head>
<body>
<template id="template-field-container">
    <div class="row field-container">
        <div class="col-3 container-field-name"></div>
        <div class="col-9 container-field-body">
            <div class="container-field-report"></div>
            <div class="container-field-desc"></div>
        </div>
    </div>
</template>
<span class="submission-detail-spinner spinner-border"></span>
<p class="template-name" style="margin: 0 0 1rem 0; padding-left: 1rem;"></p>
<div class="container-fluid md-1" style="min-width: 400px">
    <div class="insert-fields-before"></div>
    <button class="btn btn-sm btn-outline-info" id="btn-add-tag">添加标签</button>
    <button class="btn btn-sm btn-outline-info">导出</button>
</div>

<script src="js/safe.js"></script>
<script>
    function createFieldLine(controller, field, reportHtml) {
        let node = document.importNode($("#template-field-container")[0].content, true);
        let fieldTypeName = submitee.fieldControllers[field.type].displayName;

        $(node).find(".container-field-name").text(`[${fieldTypeName}] ${field.name}`);
        if (field.comment) {
            $(node).find(".container-field-desc").html(field.comment);
        } else {
            $(node).find(".container-field-desc").addClass("d-none");
        }

        $(node).find(".container-field-report").html(reportHtml);
        $(node).find(".field-container").attr("data-submitee-field-name", field.name);
        $(node).find(".field-container").attr("id", controller.getContainerId(field));
        return node;
    }

    async function buildFields(submission) {
        let relative = $(".insert-fields-before")[0];

        for (let field of submitee.currentTemplate.fields) {
            let typeController = submitee.fieldControllers[field.type];

            let value = submission.attributeMap.get("body." + field.name);

            let report = await typeController.generateReportHtml(field, value);
            relative.parentNode.insertBefore(createFieldLine(typeController, field, report), relative);
        }
        document.dispatchEvent(new CustomEvent("submission-detail-loaded"));
    }

    /**
     *
     * @param {Submission} submission
     */
    function loadSubmission(submission) {
        setCurrentTemplate(submission.attributeMap.get("template-uuid"), () => {
            let relativeTimeLocale = submitee.relativeTimeLocale(submission.submitTime);
            let timeLocale = new Date(submission.submitTime).toLocaleString();
            $(".submission-detail-spinner").addClass("d-none");
            $(".template-name").html(`${submitee.currentTemplate.name}<span class="ml-1" style="font-size: 1rem; color: #e3e3e3">
 由 ${submission.submitUser} 于 <span title="${timeLocale}">${relativeTimeLocale}</span> 提交</span>`);
            let title = submission.submitUser + "于" + new Date(submission.submitTimeRaw).toLocaleTimeString() + "上传至" +
                submitee.currentTemplate.templateId + ":" + submitee.currentTemplate.version;
            setTitle(title);
            buildFields(submission);
        })
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js",
        "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "https://cdn.jsdelivr.net/npm/uppy@1.27.0/dist/uppy.min.js",
        "https://cdn.jsdelivr.net/npm/@uppy/locales@1.18.0/dist/zh_CN.min.js",
        "js/model.js",
        "js/session.js",
        "js/field-controllers.js",
        "js/ui.js"
    ]).then(() => {
        let target = submitee.currentSubmissionTarget || getQueryValue("target");
        if (!target || !submitee.uuidPattern.test(target)) {
            $(".submission-detail-spinner").addClass("d-none");
            create_toast("重要提示", "请检查链接合法性");
            return;
        }

        fetchSubmissionInfo({'unique-id': target}).then(array => {
            if (!array || array.length === 0) {
                create_toast("重要提示", "未找到目标提交");
                return;
            }
            loadSubmission(array[0]);

            let addTagButton = $("#btn-add-tag");
            addTagButton.on("click", () => {
                let list = new class extends ExtendedList {
                    constructor() {
                        super("#btn-add-tag");
                    }

                    onSelect(selection) {
                        console.log(selection.name + " was selected");
                    }

                    allowCreate() {
                        return true;
                    }

                    createSelection(input) {
                        if (this.getSelectionElementByKey(input)) {
                            throw Error("命名冲突");
                        }
                        return {name: input, color: "#000000"};
                    }

                    createEditContext(selection, li) {
                        let node = document.createElement("form");
                        $(node).addClass("container");
                        $(node).addClass("")
                        $(node).css("padding", "2rem");
                        $(node).css("width", "10rem");
                        let id = makeid(6);
                        $(node).html(`
<div class="row flex-row align-items-center flex-nowrap">
<label for="${id}" style="width: 3rem;margin: 3px 0">颜色</label>
<input style="padding: 0;text-align: center;width: 100%" type="color" value="${selection.color}" id="${id}"/><br/>
</div>
<div class="row flex-row align-items-center flex-nowrap">
<label for="${id}1" style="width: 3rem;margin: 3px 0">名称</label>
<input style="padding: 0;text-align: center;width: 100%" type="text" size="1" value="${selection.name}" id="${id}1"/>
<br/>
</div>
<div class="row justify-content-center">
<button type="submit" class="btn btn-sm btn-outline-primary" style="
font-size: 0.8rem; height: 1.3rem; padding: 0; width: 100%; margin-top: 0.8rem;">应用</button>
</div>
`);
                        $(node).find("input[type=text]").on("change", () => {
                            let input = $(node).find("input[type=text]")[0];
                            input.setCustomValidity("");
                        })
                        $(node).on("submit", () => {
                            let color = $(node).find("input[type=color]").val();
                            let name = $(node).find("input[type=text]").val();
                            if (!name) {
                                let input = $(node).find("input[type=text]")[0];
                                input.setCustomValidity("空命名");
                                input.reportValidity();
                                return false;
                            }
                            let newSelection = {name: name, color: color};
                            if (name !== selection.name && this.getSelectionElement(newSelection)) {
                                let input = $(node).find("input[type=text]")[0];
                                input.setCustomValidity("命名冲突");
                                input.reportValidity();
                                return false;
                            }
                            this.setActivating(null);
                            this.setContextContent(null);
                            this.replaceSelection(selection, newSelection);
                            return false;
                        });
                        return node;
                    }

                    setActivating(li) {
                        if (this.activating) {
                            $(this.activating).removeClass("active");
                        }
                        this.activating = li;
                    }

                    createNodeSelection(selection) {
                        let li = document.createElement("li");
                        $(li).css("position", "relative");
                        $(li).html(`
<div style="width: 100%; height: 100%; text-align: unset; color: ${selection.color}; display: flex; flex-direction: row; justify-content: space-between">
<span style="width: 100%; text-align: center;">${selection.name}</span>
<button class="tag-list-edit-button"><i class="material-icons" style="font-size: 1.1rem">edit</i></button>
</div>
`);
                        $(li).find(".tag-list-edit-button")[0].addEventListener("click", (evt) => {
                            evt.stopPropagation();
                            this.setActivating(li);
                            $(li).addClass("active");
                            this.setContextContent(this.createEditContext(selection, li));
                        }, true);

                        $(li).css("cursor", "pointer");
                        $(li).on("click", () => this.onSelect(selection));
                        $(li).addClass("extended-list-item");
                        $(li).addClass("extended-list-item-selection");
                        $(li).attr("data-selection-key", selection.name);
                        return li;
                    }

                    getSelectionKey(selection) {
                        return selection.name;
                    }
                }
                list.addSelection({name: "紫色", color: "#af00af"});
                list.addSelection({name: "红色", color: "#ff4242"});
                list.addSelection({name: "黄色", color: "#FFC21A"});
                list.show();
            });
        })
    })
</script>
</body>
</html>
