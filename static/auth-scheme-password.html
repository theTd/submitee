<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title></title>

    <style>
        form {
            width: 20rem;
        }

        #password-auth-scheme .container {
            padding: 1rem 1.8rem;
            background-color: #dddddd;
            border-radius: 0 10px 10px 10px;
            box-shadow: 0 0 0 2px white;
        }

        #password-auth-scheme a {
            color: gray !important;
            text-decoration: underline;
        }

        #password-auth-scheme a:hover {
            color: #c1c1c1 !important;
        }

        #password-auth-scheme a:active {
            color: #5a5a5a !important;
        }
    </style>
</head>
<body>
<form onsubmit="login();return false;" id="password-auth-scheme">
    <div class="container">
        <div class="row">
            <label for="username">用户名/邮箱</label>
        </div>
        <div class="row">
            <input type="text" id="username" autocomplete="username" class="form-control"/>
        </div>
        <div class="row mt-3">
            <label for="password">密码</label>
        </div>
        <div class="row">
            <input type="password" name="password" id="password" autocomplete="password"
                   class="form-control"/>
            <div class="d-inline position-relative">
                <div class="position-fixed" style="right: 1rem" id="reset-password-link">
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <button type="button" class="btn btn-primary btn-sm w-100" onclick="login()" id="button-login">
                登录
            </button>
            <input type="submit" class="d-none"/>
            <!--                    <button type="button" class="btn btn-primary w-100">登录</button>-->
        </div>
        <div class="row mt-1 justify-content-end third-party-oauth">
        </div>
        <div class="row mt-1 justify-content-end d-none" id="internal-account-register-link">
            <a href="#" style="font-size: 0.8rem;">站内用户注册</a>
        </div>
    </div>
</form>
<script>
    let resetPasswordLink = getQueryValue("r");
    if (resetPasswordLink) {
        resetPasswordLink = btoa(resetPasswordLink);
        createIconTooltip("question", "1rem", "gray", "忘记密码？", "top", resetPasswordLink);
    }
    let redirect = getQueryValue("d");
    if (redirect) {
        redirect = btoa(redirect);
    }

    function login() {
        let username = $("#username").val();
        let password = $("#password").val();

        let button = $("#button-login");
        if (button.hasClass("disabled")) return;

        grecaptcha.ready(function () {
            grecaptcha.execute(submitee.grecaptchaSitekey, {action: 'submit'}).then(function (token) {

                button.html(`<span class="spinner-border spinner-border-sm" role="status"></span>`);
                button.addClass("disabled");

                $.ajax({
                    url: "../auth",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        realm: submitee.currentRealmName,
                        scheme: submitee.currentSchemeName,
                        body: {
                            username: username,
                            password: password
                        }
                    }),
                    success: function (response) {
                        if (response['redirect']) {
                            setInterval(() => {
                                window.location.href = response['redirect'];
                            }, 500);
                        }
                        if (!response['accepted']) {
                            create_toast("重要提示", response['deny-message']);
                            button.text("登录");
                            button.removeClass("disabled");
                            return;
                        }

                        create_toast("提示", "<p>登录已完成</p><p>正在重定向...</p>", 2000);
                        if (!response['redirect']) {
                            setTimeout(() => {
                                if (redirect) {
                                    window.location.href = redirect;
                                } else {
                                    window.location.href = "/";
                                }
                            }, 500);
                        }
                    },
                    error: function (response) {
                        button.text("登录");
                        button.removeClass("disabled");
                    }
                })
            });
        });
    }

    function showRegisterLink() {
        $("#internal-account-register-link").removeClass("d-none")
    }

    function showRegisterDisableMessage(message) {
        let link = $("#internal-account-register-link a")[0];
        link.parentNode.replaceChild(createIconTooltip("warning", "1rem", "orange", message, "left"), link);
        showRegisterLink();
    }

    $.ajax({
        url: "../internal-account",
        method: "GET",
        success: function (response) {
            if (response["register-enabled"]) {
                showRegisterLink();
            } else if (response["register-disable-message"]) {
                showRegisterDisableMessage(response["register-disable-message"]);
            }
            submitee.grecaptchaSitekey = response["grecaptcha-sitekey"];
        },
        error: function (xhr) {
            toast_ajax_error(xhr);
        }
    })
</script>
</body>
</html>
