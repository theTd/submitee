<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title></title>

    <style>
        .main input {
            width: 100%;
        }

        .main .container-fluid {
            box-shadow: inset 4px 0 0 #797979;
            margin-bottom: 2rem;
        }

        .field-configuration {
            padding: 0;
        }

        .s-field {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            transition: .2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        .s-field:hover {
            box-shadow: inset 0 -4px 0 0 #b7b7b7;
        }

        .s-field-editing:hover {
            box-shadow: 0 0 0 3px rgb(255, 164, 7) !important;
        }

        .s-field-editing {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            background-color: rgb(253, 222, 130);
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 1);
            border: solid rgb(253, 222, 130);
            border-radius: 3px;
        }

        .field-sort-drop-area {
            position: relative;
            display: block;
            margin: 0;
            padding: 0;
            width: 100%;
            z-index: 999;
        }

        .field-sort-drop-area div {
            position: absolute;
            width: 100%;
            top: -1rem;
            height: 1.2rem;
            border: 1px red;
        }

        .field-sort-drop-area-hover {
            background-color: rgba(0, 255, 0, 0.2);
        }
    </style>
</head>
<body>
<template id="template-field-sort-drop-area">
    <div class="no-gutters field-sort-drop-area" ondragenter="dropAreaDragEnter(event)"
         ondragleave="dropAreaDragLeave(event)"
         ondrop="dropAreaDrop(event)" data-drop-area-index>
        <div></div>
    </div>
</template>
<template id="template-present-field">
    <div class="row s-field" draggable="true" ondragstart=fieldDragStart(event) data-submitee-field-name>
        <div class="col col-2 s-field-type"></div>
        <div class="position-relative require-mark d-none">
            <div class="d-inline position-absolute">
                <span style="color: red">*</span>
            </div>
        </div>
        <div class="col col-2 s-field-name"></div>
        <div class="col col-6 s-field-comment"></div>
        <div class="col col-2">
            <a href="#" onclick="editField(this)" class="btn btn-secondary btn-sm">编辑</a>
            <a href="#" onclick="deleteField(this)" class="btn btn-danger btn-sm">删除</a>
            <div class="field-error d-inline"></div>
        </div>
    </div>
</template>
<template id="template-editing-field">
    <div class="row s-field s-field-editing" data-submitee-field-name>
        <div class="col col-4 container">
            <div class="container" style="padding: 0">
                <div class="row">
                    <div class="col s-field-type"></div>
                    <div class="col s-field-name"></div>
                </div>
                <div class="row mt-1">
                    <hr class="w-100 mb-0"/>
                    <label class="field-config-require-label mt-2 col">必填项</label>
                    <div class="col d-flex flex-column justify-content-center">
                        <input class="field-config-require-checkbox col" type="checkbox"
                               data-toggle="toggle"
                               data-on="是" data-off="否"
                               data-size="sm"/>
                    </div>
                    <hr class="w-100 mt-0"/>
                </div>

                <div class="row ml-1">
                    <h5>配置项</h5>
                    <div class="container field-configuration">
                    </div>
                </div>
            </div>
            <div class="col col-6">
            </div>
            <div class="col col-2">
            </div>
        </div>
        <div class="col col-6 s-field-comment"></div>
        <div class="col col-2">
            <a href="#" onclick="applyField(this)" class="btn btn-success btn-sm">完成</a>
        </div>
    </div>
</template>

<div class="container-fluid main">
    <nav class="row col breadcrumb">
        <div class="breadcrumb-item">所有模板</div>
        <div class="breadcrumb-item" id="breadcrumb-template-name"></div>
    </nav>
    <div class="row col" id="template-fields">
        <h4>字段</h4>
        <div class="container-fluid" id="container-field">
            <div class="row">
                <div class="col col-2">类型</div>
                <div class="col col-2">标题</div>
                <div class="col col-6">注释</div>
                <div class="col col-2"></div>
            </div>
            <hr/>
            <div id="insert-fields-before"></div>
            <hr/>
            <form onsubmit="createNewField();return false;" id="create-template-form">
                <div class="row">
                    <div class="col col-2 s-field-type">
                        <!--suppress HtmlFormInputWithoutLabel -->
                        <select name="type" class="w-100 h-100" id="field-type-container">
                        </select>
                    </div>
                    <div class="col col-2 s-field-name">
                        <!--suppress HtmlFormInputWithoutLabel -->
                        <input type="text"/></div>
                    <div class="col col-8">
                        <a href="#" onclick="createNewField()" class="btn btn-sm btn-success">添加字段</a>
                    </div>
                    <input type="submit" style="display: none"/>
                </div>
            </form>
        </div>
    </div>
    <div class="row col" id="template-metadata">
        <h4>标题</h4>
        <div class="container-fluid">
            <div class="row">
                <div class="col col-2"><label for="template-metadata-name">名称</label></div>
                <div class="col col-8">
                    <label for="template-metadata-comment">注释</label>
                    <span class="ml-2 d-inline"
                          style="color:gray;align-self:flex-end;font-style: italic; font-size: 0.7rem">该段文字仅展示在模板列表</span>
                </div>
            </div>
            <div class="row">
                <div class="col col-2"><input type="text" id="template-metadata-name"/></div>
                <div class="col col-10"><input type="text" id="template-metadata-comment"/></div>
            </div>
        </div>
    </div>
    <h4>描述<span class="d-inline-block ml-2"
                style="color:gray;align-self:flex-end;font-style: italic; font-size: 0.7rem">该段文字会公布到填写页面</span></h4>
    <div class="container-fluid">
        <div id="template-desc"></div>
    </div>
</div>

<div class="row col mb-4">
    <h4 class="w-100">模板状态：</h4>
    <p>尚未发布，使用发布模板按钮来获取公开链接</p>
    <hr class="w-100"/>
    <h4 class="w-100">模板状态：</h4>
    <p>模板已经发布<a class="pl-1" href="#">获取公开链接</a>，现已有 23 个提交</p><a class="pl-2" href="#">查看提交列表</a>
    <hr class="w-100"/>
    <h4 class="w-100">模板状态：</h4>
    <p>模板已经发布<a class="pl-1" href="#">获取公开链接</a>，现已有 23 个提交，其中 2 个尚未阅读</p><a class="pl-2" href="#">查看提交列表</a>
    <hr class="w-100"/>
    <h4 class="w-100">模板状态：</h4>
    <p>模板已经发布<a class="pl-1" href="#">获取公开链接</a>，现已有 23 个提交，其中 2 个尚未阅读</p><a class="pl-2" href="#">查看提交列表</a>
    <div class="w-100"></div>
    <p class="alert alert-warning">模板发布后已经被修改，使用修订模板按钮来发布修订后的模板</p>
    <hr class="w-100"/>
    <form onsubmit="return false">
        <button class="btn btn-primary disabled" id="btn-publish-template">发布模板</button>
        <button class="btn btn-danger disabled" id="btn-cancel-template">停止发布模板</button>
        <button class="btn btn-secondary disabled" id="btn-republish-template">修订模板</button>
        <div class="btn-group">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
                其他
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" href="#">导出到CSV</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-danger" href="#">归档模板</a>
            </div>
        </div>
    </form>
</div>

<!--<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js"></script>-->
<!--<script src="js/model.js"></script>-->
<!--<script src="js/field-controllers.js"></script>-->
<!--<script src="js/toast.js"></script>-->

<script>
    function findFieldByElement(element) {
        let name = findParentAttributeByElement(element, "data-submitee-field-name")
        if (name) {
            return currentTemplate.getFieldByName(name);
        }
    }

    /**
     * @param {SField} field
     * @return {ChildNode}
     */
    function findFieldContainer(field) {
        let container = null;
        $("#container-field")[0].childNodes.forEach(value => {
            if (value.hasAttribute) {
                if (value.hasAttribute("data-submitee-field-name")) {
                    if (value.getAttribute("data-submitee-field-name") === field.name) {
                        container = value;
                    }
                }
            }
        });
        return container;
    }

    function editField(element) {
        let field = findFieldByElement(element);
        if (!field) {
            alert("unexpected element");
            return;
        }

        let container = findFieldContainer(field);
        container.parentNode.replaceChild(createEditingFieldRows(field), container);
    }

    function deleteField(element) {
        let field = findFieldByElement(element);
        let container = findFieldContainer(field);
        field.owner.removeField(field).then(() => {
            container.parentNode.removeChild(container);
            create_toast("提示", "已删除字段", 2000);
        }, error => {
            create_toast("重要提示", "操作失败: " + error, 2000);
        });
    }

    function applyField(element) {
        let field = findFieldByElement(element);
        let container = findFieldContainer(field);

        field.name = container.querySelector(".s-field-name").querySelector("input").value;
        field.comment = field["commentEditor"].txt.html();

        field.required = container.querySelector(".field-config-require-checkbox").checked;

        let controller = fieldControllers[field.type];
        if (controller) {
            controller.applyConfiguration(field);
        }

        container.parentNode.replaceChild(createFieldRow(field), container);
        dirty();
    }

    /**
     *
     * @param {SField} field
     * @return {string|string|DocumentFragment|*}
     */
    function createFieldRow(field) {
        let template = $("#template-present-field")[0];

        template.content.querySelector(".s-field").setAttribute("data-submitee-field-name", field.name);
        template.content.querySelector(".s-field-type").textContent = field.getTypeDisplayName();
        template.content.querySelector(".s-field-name").textContent = field.name;
        template.content.querySelector(".s-field-comment").innerHTML = field.comment;
        $(template.content.querySelector(".field-error")).empty();

        // region require mark
        if (field.required) {
            template.content.querySelector(".require-mark").classList.remove("d-none");
        } else {
            template.content.querySelector(".require-mark").classList.add("d-none");
        }
        // endregion

        let error = fieldControllers[field.type].validateConfiguration(field);
        if (error) {
            template.content.querySelector(".field-error").appendChild(createErrorTooltip(error));
        }

        return document.importNode(template.content, true);
    }

    /**
     * insert present field dom elements depending on current template
     */
    function loadFieldRows() {
        let nodes = Array();
        currentTemplate.fields.forEach(value => {
            nodes.push(createFieldRow(value));
        });

        let relative = $("#insert-fields-before")[0];

        let dropAreaIdx = 0;
        relative.parentNode.insertBefore(createDropArea(0), relative);

        nodes.forEach(value => {
            relative.parentNode.insertBefore(value, relative);
            relative.parentNode.insertBefore(createDropArea(++dropAreaIdx), relative);
        })
    }

    function createDropArea(index) {
        let template = $("#template-field-sort-drop-area")[0];
        template.content.querySelector(".field-sort-drop-area").setAttribute("data-drop-area-index", index);
        return document.importNode(template.content, true);
    }

    function reconstructFieldRows() {
        let rows = {};

        let container = $("#container-field")[0];
        container.childNodes.forEach(childNode => {
            if (!childNode.classList) return;
            if (childNode.classList.contains("s-field")) {
                let fieldName = childNode.getAttribute("data-submitee-field-name");
                rows[fieldName] = childNode;
                container.removeChild(childNode);
            } else if (childNode.classList.contains("field-sort-drop-area")) {
                container.removeChild(childNode);
            }
        });

        let relative = $("#insert-fields-before")[0];

        let dropAreaIdx = 0;
        container.insertBefore(createDropArea(0), relative);
        currentTemplate.fields.forEach(field => {
            let row = rows[field.name];
            if (row) {
                container.insertBefore(row, relative);
                container.insertBefore(createDropArea(++dropAreaIdx), relative);
            } else {
                console.warn("missing row for field " + field.name);
            }
        });
    }

    /**
     *
     * @param {SField} field
     * @return {DocumentFragment}
     */
    function createEditingFieldRows(field) {
        let template = $("#template-editing-field")[0];

        template.content.querySelector(".s-field-editing").setAttribute("data-submitee-field-name", field.name);
        template.content.querySelector(".s-field-type").innerHTML = `<span class="disabled" style="cursor: not-allowed">${field.getTypeDisplayName()}</span>`;
        template.content.querySelector(".s-field-name").innerHTML = `<input type="text" value="${field.name}"/>`;
        // template.content.querySelector(".s-field-comment").innerHTML = `<input type="text" value="${field.comment}"/>`
        let editorId = makeid(6);
        template.content.querySelector(".s-field-comment").innerHTML = `<div id="${editorId}">${field.comment}</div>`
        setTimeout(() => {
            let commentEditor = new window.wangEditor('#' + editorId);
            commentEditor.config.excludeMenus = ['todo'];
            commentEditor.create();
            field["commentEditor"] = commentEditor;
        }, 1);

        // region required
        let requireId = makeid(6);
        let requireLabel = template.content.querySelector(".field-config-require-label");
        requireLabel.setAttribute("for", requireId);
        let requireCheckbox = template.content.querySelector(".field-config-require-checkbox");
        requireCheckbox.id = requireId;
        if (field.required) {
            requireCheckbox.checked = true;
        } else {
            requireCheckbox.checked = false;
        }
        // endregion

        let controller = fieldControllers[field.type];
        let confHtml;
        if (controller && (confHtml = controller.generateConfigurationHtml(field))) {
            template.content.querySelector(".field-configuration").innerHTML = `<div class="container-fluid">${confHtml}</div>`;
        } else {
            template.content.querySelector(".field-configuration").innerHTML = "";
        }

        setTimeout(() => {
            let container = $(`.s-field-editing[data-submitee-field-name=${field.name}]`)[0]
            container.scrollIntoView();
            $(container.querySelector(".field-config-require-checkbox")).bootstrapToggle();
        }, 1);
        return document.importNode(template.content, true);
    }

    function createNewField(evt) {
        let container = $("#create-template-form");
        let type = container.find(".s-field-type").find("select option:selected").val();
        let name = container.find(".s-field-name").find("input").val();

        if (!type || !name) {
            create_toast("重要提示", "<span style='color: red'>字段类型和名称是必填项目</span>", 2000);
        } else {
            let field = new SField(currentTemplate, null);
            field.type = type;
            field.name = name;

            currentTemplate.addField(field).then(() => {
                let relative = $("#insert-fields-before")[0];
                relative.parentNode.insertBefore(createEditingFieldRows(field), relative);
            }, error => {
                alert(error);
            })
        }
        if (evt) {
            evt.preventDefault();
            return false;
        }
    }

    function createFieldTypeOption(value, text) {
        let node = document.createElement("option");
        node.value = value;
        node.textContent = text;
        return node;
    }

    function buildFieldTypeSelect() {
        let element = $("#field-type-container")[0];
        element.appendChild(createFieldTypeOption("", "--------"));
        Object.keys(fieldControllers).forEach(value => {
            let c = fieldControllers[value];
            element.appendChild(createFieldTypeOption(c.fieldType, getFieldTypeDisplayName(c.fieldType)));
        })
    }

    function loadTemplateMetadata() {
        $("#breadcrumb-template-name")[0].textContent = currentTemplate.name || currentTemplate.templateId;
        $("#template-metadata-name").val(currentTemplate.name).on("keyup", dirty)
        $("#template-metadata-comment").val(currentTemplate.comment).on("keyup", dirty);

        let descContainer = $("#template-desc")[0];
        descContainer.innerHTML = currentTemplate.desc;
        let editor = new window.wangEditor('#template-desc');
        editor.config.excludeMenus = ['todo'];
        editor.config.onchange = dirty;
        editor.create();
        currentTemplate.descEditor = editor;
    }

    function checkAndSync() {
        if (!currentTemplate.latest) {
            currentTemplate.name = $("#template-metadata-name").val();
            currentTemplate.comment = $("#template-metadata-comment").val();
            currentTemplate.desc = currentTemplate.descEditor.txt.html();

            currentTemplate.sync().then(() => {
                create_toast("提示", "对模板的更改已保存", 2000);
                currentTemplate.latest = true;
            }, error => {
                currentTemplate.latest = false;
                create_toast("重要提示", "保存模板时出现问题: " + error, 10000);
            });
        }
    }

    function dirty() {
        currentTemplate.latest = false;
    }

    function fieldDragStart(evt) {
        let field = findFieldByElement(evt.target);
        if (!field) {
            console.log("cannot find field of dragged element");
            return;
        }

        evt.dataTransfer.dropEffect = "move";
        evt.dataTransfer.setData("field-sort", field.name);
    }

    function dropAreaDragEnter(evt) {
        evt.target.classList.add("field-sort-drop-area-hover");
    }

    function dropAreaDragLeave(evt) {
        evt.target.classList.remove("field-sort-drop-area-hover");
    }

    function dropAreaDrop(evt) {
        // reset style
        dropAreaDragLeave(evt);

        let field = currentTemplate.getFieldByName(evt.dataTransfer.getData("field-sort"));

        // find target index
        let targetIndex = parseInt(evt.target.parentNode.getAttribute("data-drop-area-index"));
        let originalIndex = currentTemplate.findFieldIndex(field);
        if (originalIndex === targetIndex || originalIndex === targetIndex - 1) {
            console.log(`nothing changed, originalIndex=${originalIndex}, targetIndex==${targetIndex}`);
            return;
        }

        field.owner.moveField(field, targetIndex).then(() => {
            create_toast("提示", "对模板的更改已保存", 2000);
        }, error => {
            create_toast("重要提示", `<span style="color:red">修改模板失败： ${error}</span>`, 10000);
        });
        reconstructFieldRows();
    }

    configuration = {};

    async function fetchConfiguration() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: "../configuration",
                method: "GET",
                success: function (data) {
                    configuration = data;
                    resolve();
                },
                error: function (error) {
                    toast_ajax_error(error);
                    reject();
                }
            })
        })

    }

    let fetchingConfiguration = fetchConfiguration();
    buildFieldTypeSelect();

    let currentTemplate;
    let currentTemplateId = getQueryValue("target");

    fetchSingleTemplateInfo(currentTemplateId).then(value => {
        fetchingConfiguration.then(() => {
            currentTemplate = value;
            currentTemplate.latest = true;

            loadTemplateMetadata();
            loadFieldRows();

            // check changes made every 2 seconds
            setInterval(checkAndSync, 2000);
        })
    }, reject => {
        alert(reject.message);
        window.history.back();
    });

    submitee.beforeUnloadChecker = function () {
        if (!currentTemplate.latest) {
            return "saving template";
        }
    }
</script>
</body>
</html>
