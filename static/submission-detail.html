<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

    <link rel="stylesheet" href="css/global.css">
    <style>
        .template-name {
            width: 100%;
            margin-left: 1rem;
            background-color: #8d8d8d;
            font-size: 2rem;
            color: white;
        }
    </style>
</head>
<body>
<template id="template-field-container">
    <div class="row field-container">
        <div class="col-3 container-field-name"></div>
        <div class="col-9 container-field-body">
            <div class="container-field-input"></div>
            <div class="container-field-desc"></div>
        </div>
    </div>
</template>
<p class="template-name" style="margin: 0 0 1rem 0; padding-left: 1rem;"></p>
<div class="container md-1" style="width: 30rem; ">
    <div class="insert-fields-before"></div>
    <button class="btn btn-sm btn-outline-info">导出</button>
</div>

<script src="js/safe.js"></script>
<script>
    function createFieldLine(controller, field, html) {
        let template = $("#template-field-container")[0];
        let fieldType = submitee.fieldControllers[field.type].displayName;
        template.content.querySelector(".container-field-name").textContent = `[${fieldType}] ${field.name}`;
        if (field.comment) {
            template.content.querySelector(".container-field-desc").innerHTML = field.comment;
            template.content.querySelector(".container-field-desc").style.display = "inline-block";
        } else {
            template.content.querySelector(".container-field-desc").innerHTML = "";
            template.content.querySelector(".container-field-desc").style.display = "none";
        }

        template.content.querySelector(".container-field-input").innerHTML = html;
        template.content.querySelector(".field-container").setAttribute("data-submitee-field-name", field.name);
        template.content.querySelector(".field-container").id = controller.getContainerId(field);
        return document.importNode(template.content, true);
    }

    async function buildFields(submission) {
        let relative = $(".insert-fields-before")[0];

        for (let field of submitee.currentTemplate.fields) {
            let typeController = submitee.fieldControllers[field.type];

            let value = submission.attributeMap.get("body." + field.name);

            let report = await typeController.generateReportHtml(field, value);
            relative.parentNode.insertBefore(createFieldLine(typeController, field, report), relative);
        }
        document.dispatchEvent(new CustomEvent("submission-detail-loaded"));
    }

    /**
     *
     * @param {Submission} submission
     */
    function loadSubmission(submission) {
        setCurrentTemplate(submission.attributeMap.get("template-uuid"), () => {
            $(".template-name").html(`${submitee.currentTemplate.name}<span class="ml-1" style="font-size: 1rem; color: #e3e3e3">
 由 ${submission.submitUser} 于 ${submission.submitTime} 提交</span>`);
            let title = submission.submitUser + "于" + new Date(submission.submitTimeRaw).toLocaleTimeString() + "上传至" +
                submitee.currentTemplate.templateId + ":" + submitee.currentTemplate.version;
            setTitle(title);
            buildFields(submission);
        })
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js",
        "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "https://releases.transloadit.com/uppy/v1.18.0/uppy.min.js",
        "https://releases.transloadit.com/uppy/locales/v1.18.0/zh_CN.min.js",
        "js/model.js",
        "js/toast.js",
        "js/field-controllers.js",
        "js/session.js"
    ]).then(() => {
        let target = submitee.currentSubmissionTarget;
        if (!target) {
            create_toast("unknown submission target")
            return;
        }
        fetchSubmissionInfo({'unique-id': target}).then(array => {
            if (!array || array.length === 0) {
                create_toast("提示", "未找到");
                return;
            }
            loadSubmission(array[0]);
        })
    })
</script>
</body>
</html>