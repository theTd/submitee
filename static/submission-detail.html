<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

    <link rel="stylesheet" href="css/global.css">
</head>
<body>
<template id="template-field-container">
    <div class="row field-container">
        <div class="col-3 container-field-name"></div>
        <div class="col-9 container-field-body">
            <div class="container-field-input"></div>
            <div class="container-field-desc"></div>
        </div>
    </div>
</template>
<div class="container mt-3" style="width: 30rem">
    <div class="row">
        <h4 id="template-name"></h4>
    </div>
    <div class="row">
        <div id="template-desc"></div>
    </div>
    <div id="insert-fields-before"></div>
    <button class="btn btn-sm btn-outline-info">导出</button>
</div>

<script src="js/safe.js"></script>
<script>
    function createFieldLine(controller, field, html) {
        let template = $("#template-field-container")[0];
        let fieldType = submitee.fieldControllers[field.type].displayName;
        template.content.querySelector(".container-field-name").textContent = `[${fieldType}] ${field.name}`;
        if (field.comment) {
            template.content.querySelector(".container-field-desc").innerHTML = field.comment;
            template.content.querySelector(".container-field-desc").style.display = "inline-block";
        } else {
            template.content.querySelector(".container-field-desc").innerHTML = "";
            template.content.querySelector(".container-field-desc").style.display = "none";
        }

        template.content.querySelector(".container-field-input").innerHTML = html;
        template.content.querySelector(".field-container").setAttribute("data-submitee-field-name", field.name);
        template.content.querySelector(".field-container").id = controller.getContainerId(field);
        return document.importNode(template.content, true);
    }

    // function loadMetadata() {
    //     setTitle(submitee.currentTemplate.name);
    //     $("#template-name").text(submitee.currentTemplate.name);
    //     $("#template-desc").html(submitee.currentTemplate.desc);
    // }

    if (!submitee.initializedControllers)
        submitee.initializedControllers = Array();

    async function initAllControllers(callback) {
        let promises = Array();
        for (let fieldType of Object.keys(submitee.fieldControllers)) {
            if (!initializedControllers.includes(fieldType)) {
                initializedControllers.push(fieldType);
                let controller = submitee.fieldControllers[fieldType];
                promises.push(controller.submissionInit());
            }
        }
        Promise.all(promises).then(callback);
    }

    async function buildFields(submission) {
        let relative = $("#insert-fields-before")[0];

        for (let field of submitee.currentTemplate.fields) {
            let typeController = submitee.fieldControllers[field.type];

            let value = submission.attributeMap.get("body." + field.name);

            let report = await typeController.generateReportHtml(field, value);
            relative.parentNode.insertBefore(createFieldLine(typeController, field, report), relative);
        }
        document.dispatchEvent(new CustomEvent("submission-detail-loaded"));
    }

    /**
     *
     * @param {Submission} submission
     */
    function loadSubmission(submission) {
        setCurrentTemplate(submission.attributeMap.get("template-uuid"), () => {
            let title = submission.submitUser + "于" + new Date(submission.submitTimeRaw).toLocaleTimeString() + "上传至" +
                submitee.currentTemplate.templateId + ":" + submitee.currentTemplate.version;
            setTitle(title);
            buildFields(submission);
        })
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js",
        "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "https://releases.transloadit.com/uppy/v1.18.0/uppy.min.js",
        "https://releases.transloadit.com/uppy/locales/v1.18.0/zh_CN.min.js",
        "js/model.js",
        "js/toast.js",
        "js/field-controllers.js",
        "js/session.js"
    ]).then(() => {
        let target = submitee.currentSubmissionTarget;
        if (!target) {
            create_toast("unknown submission target")
            return;
        }
        initAllControllers();
        fetchSubmissionInfo({'unique-id': target}).then(array => {
            if (!array || array.length === 0) {
                create_toast("提示", "未找到");
                return;
            }
            loadSubmission(array[0]);
        })
    })
</script>
</body>
</html>