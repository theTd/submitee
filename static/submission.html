<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://releases.transloadit.com/uppy/v1.27.0/uppy.min.css" rel="stylesheet">

    <title>正在载入</title>

    <style>
        #template-desc {
            margin-top: 2rem;
            padding-left: 1rem;
            box-shadow: inset 4px 0 0 #797979;
            margin-bottom: 2rem;
        }

        #field-container .row {
            margin-bottom: 2rem;
        }

        .field-container {
            padding-top: 0.2rem;
            padding-bottom: 0.2rem;
            transition: 0.2s cubic-bezier(0.22, 0.61, 0.36, 1);
            border-radius: 10px;
        }

        .slow-fade {
            transition: 5s ease !important;
        }

        .field-container.field-container-alert {
            background-color: #ff7171;
        }

        .field-container:hover {
            box-shadow: 0 0 0 3px rgb(255, 191, 110) !important;
        }

        @media (max-width: 992px) {
            .container-field-name {
                margin-bottom: 1rem;
            }

            .container-field-body {
                box-shadow: inset 4px 0 0 #797979;
            }
        }

        .container-field-desc {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.7rem;
            border: 3px orange dotted;
            border-radius: 10px;
        }
    </style>
</head>
<body onbeforeunload="return ''">
<template id="template-field-container">
    <div class="row field-container">
        <div class="position-relative require-mark d-none">
            <div class="d-inline position-absolute">
                <span style="color: #ff8989">*</span>
            </div>
        </div>
        <div class="col-12 col-lg-2 container-field-name"></div>
        <div class="col-12 col-lg-10 container-field-body">
            <div class="container-field-input"></div>
            <div class="container-field-desc"></div>
        </div>
    </div>
</template>
<div class="container mt-3" id="main">
    <div class="row">
        <h4 id="template-name"></h4>
    </div>
    <div class="row">
        <div id="template-desc"></div>
    </div>

    <hr/>
    <form class="mb-3" id="field-container" onsubmit="createSubmission();return false;">
        <hr id="insert-fields-before"/>
        <input type="submit" class="btn btn-primary" value="提交"/>
    </form>
</div>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js"></script>
<script src="https://releases.transloadit.com/uppy/v1.18.0/uppy.min.js"></script>
<script src="https://releases.transloadit.com/uppy/locales/v1.18.0/zh_CN.min.js"></script>

<script src="js/model.js"></script>
<script src="js/toast.js"></script>
<script src="js/field-controllers.js"></script>

<script>

    function createSubmission() {
        let body = {};
        let result = "";

        let missingRequired = false;
        currentTemplate.fields.forEach(field => {
            if (missingRequired) return;
            let controller = fieldControllers[field.type];
            if (!controller) {
                result += `[!]${field.name}: no controller`
            } else {
                try {
                    let resolve = controller.resolveSubmission(field);
                    if (Array.isArray(resolve) && resolve.length === 0) resolve = undefined;
                    if (resolve === "") resolve = undefined;
                    if (resolve === {}) resolve = undefined;
                    if (resolve) {
                        body[field.name] = resolve;
                    } else if (field.required) {
                        missingRequired = true;
                        let container = $(`.field-container[data-submitee-field-name=${field.name}]`)[0];
                        if (container) {
                            container.classList.add("field-container-alert");
                            container.scrollIntoView();
                            setTimeout(() => {
                                container.classList.add("slow-fade");
                                container.classList.remove("field-container-alert");
                            }, 1000);
                            setTimeout(() => {
                                container.classList.remove("slow-fade");
                            }, 6000)
                            create_toast("重要提示", field.name + "是必填项目");
                        }
                        return;
                    }
                    result += resolve ? `[o]${field.name}: ${resolve}` : `[x]${field.name}`;
                } catch (e) {
                    console.log(e);
                    result += `[!]${field.name}: internal error: ${JSON.stringify(e)}`
                }
            }
            result += "\n";
        })
        if (missingRequired) return;
        console.log(result);
    }

    /**
     * @param {SField} field
     */
    function createErrorLine(field) {
        let node = document.createElement("div");
        node.classList.add("alert");
        node.classList.add("alert-warning");
        node.innerText = "未知字段：" + field.type;
        return node;
    }

    function createFieldLine(controller, field, html) {
        let template = $("#template-field-container")[0];
        template.content.querySelector(".container-field-name").textContent = field.name;
        if (field.comment) {
            template.content.querySelector(".container-field-desc").innerHTML = field.comment;
            template.content.querySelector(".container-field-desc").style.display = "inline-block";
        } else {
            template.content.querySelector(".container-field-desc").innerHTML = "";
            template.content.querySelector(".container-field-desc").style.display = "none";
        }

        // region require mark
        if (field.required) {
            template.content.querySelector(".require-mark").classList.remove("d-none");
        } else {
            template.content.querySelector(".require-mark").classList.add("d-none");
        }
        // endregion

        template.content.querySelector(".container-field-input").innerHTML = html;
        template.content.querySelector(".field-container").setAttribute("data-submitee-field-name", field.name);
        template.content.querySelector(".field-container").id = controller.getContainerId(field);
        return document.importNode(template.content, true);
    }

    function loadMetadata() {
        setTitle(currentTemplate.name);
        $("#template-name").text(currentTemplate.name);
        $("#template-desc").html(currentTemplate.desc);
    }

    initializedControllers = Array();

    function initControllers(callback, error) {
        let promises = Array();
        currentTemplate.fields.forEach(field => {
            if (!initializedControllers.includes(field.type)) {
                initializedControllers.push(field.type);
                let controller = fieldControllers[field.type];
                promises.push(controller.submissionInit());
            }
        })
        Promise.all(promises).then(callback).catch(reject => error(reject));
    }

    function buildFields() {
        let relative = $("#insert-fields-before")[0];

        currentTemplate.fields.forEach((value, index) => {
            let typeController = fieldControllers[value.type];
            if (!typeController) {
                relative.parentNode.insertBefore(createErrorLine(value), relative);
            } else {
                relative.parentNode.insertBefore(createFieldLine(typeController, value,
                    typeController.generateSubmissionHtml(value)), relative);
            }
        })
    }

    let target = getQueryValue("target");
    let currentTemplate;

    if (!target) {
        alert("出现了一些意料之外的异常，如需帮助请联系管理员");
        window.history.back();
    } else {
        fetchSingleTemplateInfo(target).then(value => {
            currentTemplate = value;
            submitee.submission = {};

            loadMetadata();
            initControllers(buildFields, (error) => {
                alert(error);
            })
        }, error => {
            alert("出现了一些意料之外的异常，如需帮助请联系管理员");
            window.history.back();
        });
    }
</script>
</body>
</html>
