<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title></title>

    <style>
        .template-container {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .template-container > .col {
            align-self: center;
        }

        .s-template-id, .s-template-status {
            font-size: 0.8rem;
        }

        .template-container span {
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
            display: inline-block;
        }

        span.template-status-editing {
            border: 1px #17a2b8 solid;
            color: #17a2b8;
        }

        span.template-status-published {
            border: 1px #28a745 solid;
            background-color: #28a745;
            color: white !important;
        }

        span.template-status-archived {
            border: 1px #dc3545 solid;
            color: #dc3545;
        }

        .template-filters > * {
            vertical-align: middle;
        }

        .template-filters > label {
            margin: 0;
        }
    </style>
</head>
<body>

<template id="template-s-template-row">
    <div class="row template-container" data-submitee-template-id>
        <div class="col col-1 s-template-id"></div>
        <div class="col col-1 s-template-status"></div>
        <div class="col col-2 s-template-name"></div>
        <div class="col col-6 s-template-comment"></div>
        <div class="col col-2">
            <div class="template-link-container position-relative d-none" style="right: 2.5rem"></div>
            <button class="btn btn-sm btn-secondary button-edit-template d-none" onclick="editTemplate(this)">
                编辑
            </button>
            <button class="btn btn-sm btn-outline-danger button-archive-template d-none"
                    onclick="archiveTemplate(this)">
                归档
            </button>
            <button class="btn btn-sm btn-info button-view-template d-none" onclick="editTemplate(this)">
                查看
            </button>
            <button class="btn btn-sm btn-warning button-revision-template d-none" onclick="revisionTemplate(this)">
                修订
            </button>
            <button class="btn btn-sm btn-danger button-delete-template d-none" onclick="deleteTemplate(this)">
                删除
            </button>
        </div>
    </div>
</template>
<template id="template-list-page-item">
    <li class="page-item"><a class="page-link" href="#">3</a></li>
</template>

<div class="container-fluid">
    <div class="row">
        <div class="col col-1">编号</div>
        <div class="col col-1">状态</div>
        <div class="col col-2">标题</div>
        <div class="col col-6">注释</div>
        <div class="col col-2"></div>
    </div>
    <hr/>
    <div class="row empty-mark d-none col-12 justify-content-center" style="color: gray; font-style: italic">(空)</div>
    <hr id="insert-template-before"/>
    <nav class="row col">
        <ul class="pagination" id="template-list-pagination">
        </ul>
    </nav>
    <hr/>
    <div class="row justify-content-end mb-3">
        <div class="col col-10 template-filters">
            <label for="checkbox-latest-version">最新版本</label>
            <input type="checkbox" id="checkbox-latest-version" data-toggle="toggle" data-size="sm" data-on="开"
                   data-off="关"/>
            <label for="checkbox-show-archived" class="ml-4">显示归档</label>
            <input type="checkbox" id="checkbox-show-archived" data-toggle="toggle" data-size="sm" data-on="开"
                   data-off="关"/>
            <label for="checkbox-published-only" class="ml-4">已发布</label>
            <input type="checkbox" id="checkbox-published-only" data-toggle="toggle" data-size="sm" data-on="开"
                   data-off="关"/>
            <button class="ml-4 btn btn-info btn-sm" onclick="applyFilter()">更新</button>
        </div>
        <div class="col">
            <a class="btn btn-outline-success" href="#" onclick="createTemplate()">创建<br/>模板</a>
        </div>

    </div>
</div>

<script src="js/safe.js"></script>
<script>
    function archiveTemplate(element) {
        let templateId = findTemplateIdByElement(element);

        $.ajax({
            url: `../template-control/${templateId}/archive`,
            method: "GET",
            success: function (response) {
                create_toast("提示", "已完成");
                setInterval(() => {
                    window.location.reload();
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr);
            }
        });
    }

    function deleteTemplate(element) {
        let templateId = findTemplateIdByElement(element);

        $.ajax({
            url: `../template-control/${templateId}/delete`,
            method: "GET",
            success: function (response) {
                create_toast("提示", "已完成");
                setInterval(() => {
                    window.location.reload();
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr);
            }
        });
    }

    function applyFilter() {
        let page = parseInt(getQueryValue("page")) || 1;
        window.location.href = fullUri(page);
    }

    function fullUri(page) {
        return `?method=template-list&page=${page}${filterParams()}`;
    }

    function filterParams() {
        return `&ac=${$("#checkbox-show-archived").prop("checked")}&lv=${$("#checkbox-latest-version").prop("checked")}&pb=${$("#checkbox-published-only").prop("checked")}`;
    }

    function revisionTemplate(element) {
        let id = findTemplateIdByElement(element);
        $.ajax({
            url: "../create/template/" + id,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({}),
            success: function (data) {
                create_toast("提示", "<p>正在重定向...</p>");
                setTimeout(() => {
                    window.location.href = "?method=edit-template&target=" + data;
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr)
            }
        });
    }

    function createTemplate() {
        $.ajax({
            url: "../create/template",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({}),
            success: function (data) {
                create_toast("提示", "<p>创建成功</p><p>正在重定向...</p>");
                setTimeout(() => {
                    window.location.href = "?method=edit-template&target=" + data;
                }, 500);
            },
            error: function (xhr) {
                toast_ajax_error(xhr)
            }
        });
    }

    function findTemplateIdByElement(element) {
        let node = element;
        let fieldId;
        while (node) {
            if (node.hasAttribute("data-submitee-template-id")) {
                fieldId = node.getAttribute("data-submitee-template-id");
                break;
            }
            node = node.parentNode;
        }
        return fieldId;
    }

    function editTemplate(element) {
        let templateId = findTemplateIdByElement(element);
        window.location.href = "management.html?method=edit-template&target=" + templateId;
    }

    /**
     *
     * @param {STemplate} template
     */
    function createTemplateElement(template) {
        let t = document.querySelector("#template-s-template-row");
        t.content.querySelector(".template-container").setAttribute("data-submitee-template-id", template.uniqueId);
        t.content.querySelector(".s-template-id").textContent = template.templateId + ":" + template.version;
        t.content.querySelector(".s-template-status").innerHTML = template.status;
        t.content.querySelector(".s-template-name").textContent = template.name;
        t.content.querySelector(".s-template-comment").textContent = template.comment;

        if (template.published) {
            let link = t.content.querySelector(".template-link-container");
            link.classList.remove("d-none");
            link.appendChild(createOutFlowIconTooltip("link", "2rem", "gray", "转到", "top",
                "submission.html?target=" + template.uniqueId));

            t.content.querySelector(".button-revision-template").classList.remove("d-none");
            t.content.querySelector(".button-view-template").classList.remove("d-none");
            t.content.querySelector(".button-edit-template").classList.add("d-none");
            t.content.querySelector(".button-archive-template").classList.add("d-none");
            t.content.querySelector(".button-delete-template").classList.add("d-none");
        } else {
            t.content.querySelector(".template-link-container").classList.add("d-none");
            t.content.querySelector(".button-view-template").classList.add("d-none");

            if (template.archived) {
                t.content.querySelector(".button-revision-template").classList.remove("d-none");
                t.content.querySelector(".button-edit-template").classList.add("d-none");
                t.content.querySelector(".button-archive-template").classList.add("d-none");
                t.content.querySelector(".button-delete-template").classList.remove("d-none");
            } else {
                t.content.querySelector(".button-revision-template").classList.add("d-none");
                t.content.querySelector(".button-edit-template").classList.remove("d-none");
                t.content.querySelector(".button-archive-template").classList.remove("d-none");
                t.content.querySelector(".button-delete-template").classList.add("d-none");
            }
        }

        return document.importNode(t.content, true);
    }

    function buildTemplateList(templateList) {
        let relative = $("#insert-template-before")[0];
        templateList.forEach(function (value) {
            relative.parentNode.insertBefore(createTemplateElement(value), relative);
        })
    }

    function buildPagination(currentPage, maxPages) {
        let paginationContainer = $("#template-list-pagination")[0];
        let prevPage = currentPage - 1;
        if (prevPage < 1) prevPage = null;
        let nextPage = currentPage + 1;
        if (nextPage > maxPages) nextPage = null;

        let node;
        node = createPageItem("上一页", prevPage ? fullUri(prevPage) : "");
        if (!prevPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);

        for (let i = 1; i <= maxPages; i++) {
            paginationContainer.appendChild(createPageItem(i, fullUri(i), i === currentPage));
        }

        node = createPageItem("下一页", nextPage ? fullUri(nextPage) : "");
        if (!nextPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);
    }

    function createPageItem(text, href, active) {
        let t = $("#template-list-page-item")[0];
        t.content.querySelector(".page-link").href = href;
        t.content.querySelector(".page-link").textContent = text;
        if (active) {
            $(t.content.querySelector(".page-item")).addClass("active");
        } else {
            $(t.content.querySelector(".page-item")).removeClass("active");
        }
        return document.importNode(t.content, true);
    }

    submitee_safe.loadAllScript([
        "https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js",
        "https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js",
        "https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js",
        "https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js",
        "js/model.js",
        "js/field-controllers.js",
        "js/toast.js",
        "js/session.js",
    ]).then(() => {
        const pageSize = 10;
        let page = parseInt(getQueryValue("page")) || 1;
        // noinspection EqualityComparisonWithCoercionJS
        let showArchived = getQueryValue("ac") == 'true';
        // noinspection EqualityComparisonWithCoercionJS
        let latestVersion = getQueryValue("lv") == 'true';
        // noinspection EqualityComparisonWithCoercionJS
        let publishedOnly = getQueryValue("pb") == 'true';

        $("#checkbox-show-archived").prop("checked", showArchived).bootstrapToggle();
        $("#checkbox-latest-version").prop("checked", latestVersion).bootstrapToggle();
        $("#checkbox-published-only").prop("checked", publishedOnly).bootstrapToggle();

        let filters = {};
        if (!showArchived) {
            filters["$or"] = [
                {"archived": {"$exists": false}},
                {"archived": false}
            ];
        }
        if (publishedOnly) {
            filters["published"] = true;
        }

        fetchTemplateSize(filters, latestVersion).then(size => {
            if (size === 0) {
                $(".empty-mark").removeClass("d-none");
                return;
            }
            let maxPages = Math.ceil(size / pageSize);
            if (page > maxPages) page = maxPages;
            buildPagination(page, maxPages);
            fetchTemplateInfo(filters, latestVersion, (page - 1) * pageSize, pageSize)
                .then(buildTemplateList, toast_ajax_error)
        }, toast_ajax_error);
    });

</script>
</body>
</html>