<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title></title>

    <style>
        .template-container {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

<template id="template-s-template-row">
    <div class="row template-container" data-submitee-template-id>
        <div class="col col-2 s-template-id"></div>
        <div class="col col-2 s-template-name"></div>
        <div class="col col-6 s-template-comment"></div>
        <div class="col col-2">
            <a class="btn btn-secondary" href="#" onclick="editTemplate(this)">编辑</a>
        </div>
    </div>
</template>
<template id="template-list-page-item">
    <li class="page-item"><a class="page-link" href="#">3</a></li>
</template>

<div class="container-fluid">
    <div class="row">
        <div class="col col-2">编号</div>
        <div class="col col-2">标题</div>
        <div class="col col-6">注释</div>
        <div class="col col-2"></div>
    </div>
    <hr/>
    <hr id="insert-template-before"/>
    <nav class="row col">
        <ul class="pagination" id="template-list-pagination">
        </ul>
    </nav>
    <hr/>
    <div class="row col justify-content-end mb-3">
        <a class="btn btn-primary" href="#" onclick="createTemplate()">创建模板</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>
<script src="js/model.js"></script>
<script>

    function createTemplate() {
        $.ajax({
            url: "../create/",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                type: 'STemplate'
            }),
            success: function (data) {
                window.location.href = "?method=edit-template&target=" + data;
            },
            error: function (error) {
                console.log(Object.keys(error));
                if (error.responseText) {
                    alert(error.responseText);
                } else {
                    alert(error.status);
                }
            }
        });
        // todo apply new template then switch to editing template page
    }

    function findTemplateIdByElement(element) {
        let node = element;
        let fieldId;
        while (node) {
            if (node.hasAttribute("data-submitee-template-id")) {
                fieldId = node.getAttribute("data-submitee-template-id");
                break;
            }
            node = node.parentNode;
        }
        return fieldId;
    }

    function editTemplate(element) {
        let templateId = findTemplateIdByElement(element);
        window.location.href = "management.html?method=edit-template&target=" + templateId;
    }

    /**
     *
     * @param {STemplate} template
     */
    function createTemplateElement(template) {
        let element = document.querySelector("#template-s-template-row");
        element.content.querySelector(".template-container").setAttribute("data-submitee-template-id", template.uniqueId);
        element.content.querySelector(".s-template-id").textContent = template.templateId;
        element.content.querySelector(".s-template-name").textContent = template.name;
        element.content.querySelector(".s-template-comment").textContent = template.comment;
        return document.importNode(element.content, true);
    }

    function buildTemplateList(templateList) {
        let relative = $("#insert-template-before")[0];
        templateList.forEach(function (value, key) {
            relative.parentNode.insertBefore(createTemplateElement(value), relative);
        })
    }

    function buildPagination(currentPage, maxPages) {
        let paginationContainer = $("#template-list-pagination")[0];
        let prevPage = currentPage - 1;
        if (prevPage < 1) prevPage = null;
        let nextPage = currentPage + 1;
        if (nextPage > maxPages) nextPage = null;

        let node;
        node = createPageItem("上一页", prevPage ? "?method=template-list&page=" + prevPage : "");
        if (!prevPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);

        for (let i = 1; i <= maxPages; i++) {
            paginationContainer.appendChild(createPageItem(i, "?method=template-list&page=" + i, i === currentPage));
        }

        node = createPageItem("下一页", nextPage ? "?method=template-list&page=" + nextPage : "");
        if (!nextPage) {
            $(node.querySelector(".page-item")).addClass("disabled");
        }
        paginationContainer.appendChild(node);
    }

    function createPageItem(text, href, active) {
        let t = $("#template-list-page-item")[0];
        t.content.querySelector(".page-link").href = href;
        t.content.querySelector(".page-link").textContent = text;
        if (active) {
            $(t.content.querySelector(".page-item")).addClass("active");
        } else {
            $(t.content.querySelector(".page-item")).removeClass("active");
        }
        return document.importNode(t.content, true);
    }

    const pageSize = 10;
    let page = parseInt(getQueryVariable("page")) || 1;
    fetchTemplateInfo({}, true).then(array => {
        let maxPages = Math.ceil(array.length / pageSize);
        if (page > maxPages) page = maxPages;
        buildPagination(page, maxPages);

        let shown = Array();
        for (let i = pageSize * (page - 1); i < pageSize * page && i < array.length; i++) {
            shown.push(array[i]);
        }

        buildTemplateList(shown);
    }, reject => {
        alert(reject);
        window.location.refresh();
    });
</script>
</body>
</html>